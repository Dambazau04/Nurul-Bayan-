<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nurul Bayan Science Academy - SMS</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Noto+Naskh+Arabic:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#065f46', // Emerald 800
                        secondary: '#d97706', // Amber 600
                        accent: '#10b981', // Emerald 500
                    },
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                        arabic: ['Noto Naskh Arabic', 'serif'],
                    }
                }
            }
        }
    </script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- SheetJS for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.css"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- QRCode JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        body { background-color: #f0fdf4; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #ecfdf5; }
        ::-webkit-scrollbar-thumb { background: #059669; border-radius: 10px; }

        /* Print Specifics - CRITICAL */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
                margin: 0;
                padding: 0;
                background: white;
            }
            .no-print { display: none !important; }
            .page-break { page-break-before: always; }
            
            /* Report Card A4 Portrait */
            .report-card-page {
                width: 210mm;
                height: 296mm; /* A4 */
                padding: 0;
                margin: 0 auto;
                background: white;
                position: relative;
                overflow: hidden;
            }

            /* Timetable A4 Landscape */
            .timetable-page {
                width: 297mm;
                height: 208mm;
                padding: 10mm;
                transform: rotate(0deg);
            }
        }
    </style>
</head>
<body class="text-gray-800 font-sans">

    <!-- Auth Overlay -->
    <div id="auth-screen" class="fixed inset-0 bg-gradient-to-br from-emerald-900 to-emerald-700 z-50 flex items-center justify-center p-4">
        <div class="glass-panel p-8 rounded-2xl shadow-2xl w-full max-w-md text-center transform transition-all hover:scale-105 duration-300">
            <div class="w-24 h-24 bg-white mx-auto mb-6 rounded-full flex items-center justify-center shadow-lg border-4 border-yellow-400">
                <i class="fas fa-graduation-cap text-4xl text-emerald-800"></i>
            </div>
            <h1 class="text-3xl font-bold text-emerald-900 mb-1">NURUL BAYAN</h1>
            <p class="text-emerald-700 text-sm mb-8 font-medium">Science Academy Management System</p>
            
            <form id="login-form" class="space-y-4">
                <div class="relative">
                    <i class="fas fa-user absolute left-3 top-3.5 text-emerald-500"></i>
                    <input type="text" id="username" placeholder="Username" class="w-full pl-10 p-3 border border-emerald-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-emerald-50" required>
                </div>
                <div class="relative">
                    <i class="fas fa-lock absolute left-3 top-3.5 text-emerald-500"></i>
                    <input type="password" id="password" placeholder="Password" class="w-full pl-10 p-3 border border-emerald-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-emerald-50" required>
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-emerald-600 to-emerald-800 text-white p-3 rounded-lg hover:shadow-lg transition font-bold tracking-wide">LOGIN SECURELY</button>
            </form>
            <p class="mt-6 text-xs text-emerald-800 opacity-70">Restricted Access. Authorized Personnel Only.</p>
        </div>
    </div>

    <!-- Main App Layout (Hidden by default) -->
    <div id="app-container" class="hidden flex h-screen overflow-hidden bg-gray-50">
        
        <!-- Sidebar -->
        <aside class="w-72 bg-gradient-to-b from-emerald-900 to-emerald-800 text-white flex flex-col hidden md:flex shadow-2xl z-20">
            <div class="p-6 text-center border-b border-emerald-700/50">
                <div class="w-20 h-20 bg-white text-emerald-900 rounded-full flex items-center justify-center mx-auto text-3xl font-bold mb-3 shadow-lg border-2 border-yellow-400">NB</div>
                <h2 class="font-bold text-lg tracking-wide">NURUL BAYAN</h2>
                <p class="text-xs text-emerald-300 uppercase tracking-widest">Admin Portal</p>
            </div>
            <nav class="flex-1 overflow-y-auto py-6 space-y-1 px-3">
                <button onclick="nav('dashboard')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-emerald-700/50 transition flex items-center gap-3 active-nav bg-emerald-700/50 shadow-inner"><i class="fas fa-home w-6"></i> Dashboard</button>
                <button onclick="nav('students')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-emerald-700/50 transition flex items-center gap-3"><i class="fas fa-user-graduate w-6"></i> Students</button>
                <button onclick="nav('academics')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-emerald-700/50 transition flex items-center gap-3"><i class="fas fa-book-open w-6"></i> Academics</button>
                <button onclick="nav('finance')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-emerald-700/50 transition flex items-center gap-3"><i class="fas fa-money-bill-wave w-6"></i> Finance</button>
                <button onclick="nav('timetable')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-emerald-700/50 transition flex items-center gap-3"><i class="fas fa-calendar-alt w-6"></i> Timetable</button>
            </nav>
            <div class="p-4 border-t border-emerald-700/50">
                <button onclick="logout()" class="w-full bg-red-600/80 hover:bg-red-600 py-2 rounded-lg text-sm transition shadow flex items-center justify-center gap-2"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
            
            <!-- Mobile Header -->
            <header class="bg-white shadow-sm p-4 flex justify-between items-center md:hidden z-20">
                <span class="font-bold text-emerald-800 text-lg">NURUL BAYAN SMS</span>
                <button onclick="toggleMobileMenu()" class="text-emerald-800"><i class="fas fa-bars text-xl"></i></button>
            </header>
            
            <!-- Mobile Menu -->
            <div id="mobile-menu" class="fixed inset-0 bg-emerald-900 text-white z-40 hidden flex flex-col p-6 backdrop-blur-sm bg-opacity-95">
                <div class="flex justify-end mb-8"><button onclick="toggleMobileMenu()"><i class="fas fa-times text-2xl"></i></button></div>
                <button onclick="nav('dashboard'); toggleMobileMenu()" class="py-4 border-b border-emerald-800 text-lg font-medium">Dashboard</button>
                <button onclick="nav('students'); toggleMobileMenu()" class="py-4 border-b border-emerald-800 text-lg font-medium">Students</button>
                <button onclick="nav('academics'); toggleMobileMenu()" class="py-4 border-b border-emerald-800 text-lg font-medium">Academics</button>
                <button onclick="nav('finance'); toggleMobileMenu()" class="py-4 border-b border-emerald-800 text-lg font-medium">Finance</button>
                <button onclick="nav('timetable'); toggleMobileMenu()" class="py-4 border-b border-emerald-800 text-lg font-medium">Timetable</button>
                <button onclick="logout()" class="py-4 text-red-300 mt-auto font-bold">Logout</button>
            </div>

            <!-- Views -->
            <div id="content-area" class="flex-1 overflow-auto p-4 md:p-8 relative scroll-smooth">
                
                <!-- Dashboard View -->
                <div id="view-dashboard" class="view-section animate-fade-in">
                    <div class="flex justify-between items-end mb-8">
                        <div>
                            <h2 class="text-3xl font-bold text-gray-800">Overview</h2>
                            <p class="text-gray-500">Welcome back, Admin</p>
                        </div>
                        <span class="bg-emerald-100 text-emerald-800 px-4 py-1 rounded-full text-sm font-bold shadow-sm">Session: 2025/2026</span>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl shadow-sm border-b-4 border-emerald-500 hover:shadow-md transition">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-gray-500 text-xs font-bold uppercase tracking-wider">Total Students</h3>
                                    <p class="text-4xl font-bold text-gray-800 mt-2" id="dash-total-students">0</p>
                                </div>
                                <div class="w-12 h-12 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center text-xl"><i class="fas fa-users"></i></div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border-b-4 border-blue-500 hover:shadow-md transition">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-gray-500 text-xs font-bold uppercase tracking-wider">Classes Active</h3>
                                    <p class="text-4xl font-bold text-gray-800 mt-2" id="dash-total-classes">16</p>
                                </div>
                                <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xl"><i class="fas fa-school"></i></div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border-b-4 border-yellow-500 hover:shadow-md transition">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-gray-500 text-xs font-bold uppercase tracking-wider">School Status</h3>
                                    <p class="text-2xl font-bold text-emerald-600 mt-2">Active</p>
                                </div>
                                <div class="w-12 h-12 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center text-xl"><i class="fas fa-check-circle"></i></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-8 border border-gray-100">
                        <div class="flex items-center gap-4 mb-6 border-b pb-4">
                             <i class="fas fa-building text-2xl text-emerald-800"></i>
                             <h3 class="font-bold text-xl text-emerald-800">School Profile</h3>
                        </div>
                        <div class="grid md:grid-cols-2 gap-8 text-sm">
                            <div class="space-y-3">
                                <div class="flex flex-col">
                                    <span class="text-xs text-gray-400 uppercase font-bold">English Name</span>
                                    <span class="text-lg font-semibold">NURUL BAYAN SCIENCE ACADEMY</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-xs text-gray-400 uppercase font-bold">Arabic Name</span>
                                    <span class="text-xl font-arabic text-emerald-700">نور البيان الأكاديمية للعلوم</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-xs text-gray-400 uppercase font-bold">Motto</span>
                                    <span class="italic text-gray-600">"Knowledge is the Root of Success"</span>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <div class="flex flex-col">
                                    <span class="text-xs text-gray-400 uppercase font-bold">Address</span>
                                    <span>No. 2222 Janbulo Housing Estate, Opposite Afforestation, Dorayi Babba, Gwale LGA, Kano</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-xs text-gray-400 uppercase font-bold">Contacts</span>
                                    <span>+234-8119723517, +234-8189231849</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-xs text-gray-400 uppercase font-bold">Email</span>
                                    <span>nurulbayanscienceacademy18@gmail.com</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Students View -->
                <div id="view-students" class="view-section hidden animate-fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <h2 class="text-2xl font-bold text-gray-800">Student Management</h2>
                        <button onclick="openModal('student-modal')" class="bg-emerald-600 text-white px-6 py-2 rounded-lg shadow hover:bg-emerald-700 transition flex items-center gap-2"><i class="fas fa-plus"></i> Add New Student</button>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="p-4 border-b flex flex-col md:flex-row gap-4 bg-gray-50/50">
                            <div class="relative flex-1">
                                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                                <input type="text" id="search-student" placeholder="Search by name..." class="border border-gray-200 p-2 pl-10 rounded-lg w-full focus:outline-none focus:border-emerald-500" onkeyup="renderStudents()">
                            </div>
                            <select id="filter-class" class="border border-gray-200 p-2 rounded-lg w-full md:w-1/4 focus:outline-none focus:border-emerald-500 cursor-pointer" onchange="renderStudents()">
                                <!-- Populated via JS -->
                            </select>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-gray-100 text-gray-600 uppercase text-xs font-semibold tracking-wider">
                                    <tr>
                                        <th class="p-4">Photo</th>
                                        <th class="p-4">Name</th>
                                        <th class="p-4">Class</th>
                                        <th class="p-4 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="student-list-body" class="text-sm divide-y divide-gray-100">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Academics View (Scores & Reports) -->
                <div id="view-academics" class="view-section hidden animate-fade-in">
                    <div class="flex justify-between items-center mb-6">
                         <h2 class="text-2xl font-bold text-gray-800">Academics & Reports</h2>
                         <button onclick="openModal('subject-modal'); renderSubjectManager()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 shadow text-sm"><i class="fas fa-cog mr-2"></i>Manage Subjects</button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <!-- Score Entry Card -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <div class="flex items-center gap-3 mb-4 border-b pb-3">
                                <div class="w-8 h-8 rounded bg-blue-100 text-blue-600 flex items-center justify-center"><i class="fas fa-edit"></i></div>
                                <h3 class="font-bold text-lg">1. Score Entry</h3>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Class</label>
                                    <select id="score-class-select" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-200 outline-none class-dropdown" onchange="loadClassForScores()">
                                        <option value="">Select Class</option>
                                    </select>
                                </div>
                                <div id="score-entry-area" class="hidden space-y-4 animate-fade-in">
                                    <div class="flex gap-4">
                                        <div class="w-2/3">
                                            <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Subject</label>
                                            <select id="score-subject-select" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-200 outline-none"></select>
                                        </div>
                                        <div class="w-1/3">
                                            <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Term</label>
                                            <select id="score-term-select" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-200 outline-none">
                                                <option value="1st">1st Term</option>
                                                <option value="2nd">2nd Term</option>
                                                <option value="3rd">3rd Term</option>
                                            </select>
                                        </div>
                                    </div>
                                    <button onclick="openScoreModal()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-medium transition shadow-lg shadow-blue-200">Open Score Sheet</button>
                                </div>
                            </div>
                        </div>

                        <!-- Report Generation Card -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                             <div class="flex items-center gap-3 mb-4 border-b pb-3">
                                <div class="w-8 h-8 rounded bg-emerald-100 text-emerald-600 flex items-center justify-center"><i class="fas fa-print"></i></div>
                                <h3 class="font-bold text-lg">2. Generate Reports</h3>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Next Term Begins</label>
                                    <input type="date" id="next-term-date" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-emerald-200 outline-none">
                                </div>
                                
                                <button onclick="generateBulkReports()" class="w-full bg-emerald-600 text-white py-3 rounded-lg hover:bg-emerald-700 font-medium transition shadow-lg shadow-emerald-200 flex items-center justify-center gap-2">
                                    <i class="fas fa-file-alt"></i> Generate Report Cards
                                </button>
                                <button onclick="exportToExcel()" class="w-full bg-green-700 text-white py-3 rounded-lg hover:bg-green-800 font-medium transition shadow-lg shadow-green-200 flex items-center justify-center gap-2">
                                    <i class="fas fa-file-excel"></i> Export Broadsheet (Excel)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Finance View -->
                <div id="view-finance" class="view-section hidden animate-fade-in">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Finance Management</h2>
                    
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-6">
                        <div class="flex items-center gap-3 mb-6 border-b pb-3">
                            <div class="w-8 h-8 rounded bg-amber-100 text-amber-600 flex items-center justify-center"><i class="fas fa-receipt"></i></div>
                            <h3 class="font-bold text-lg">Create Receipt</h3>
                        </div>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Student</label>
                                    <select id="receipt-student-select" class="p-3 border rounded-lg w-full focus:ring-2 focus:ring-emerald-200 outline-none">
                                        <option value="">Select Student...</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Amount (₦)</label>
                                    <input type="number" id="receipt-amount" placeholder="0.00" class="p-3 border rounded-lg w-full focus:ring-2 focus:ring-emerald-200 outline-none">
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Description</label>
                                    <input type="text" id="receipt-desc" placeholder="e.g. School Fees, Uniform..." class="p-3 border rounded-lg w-full focus:ring-2 focus:ring-emerald-200 outline-none">
                                </div>
                                <div class="flex gap-4">
                                    <div class="w-1/2">
                                        <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Term</label>
                                        <select id="receipt-term" class="p-3 border rounded-lg w-full focus:ring-2 focus:ring-emerald-200 outline-none">
                                            <option value="1st Term">1st Term</option>
                                            <option value="2nd Term">2nd Term</option>
                                            <option value="3rd Term">3rd Term</option>
                                        </select>
                                    </div>
                                    <div class="w-1/2 flex items-end">
                                        <button onclick="generateReceipt()" class="bg-emerald-600 text-white p-3 rounded-lg w-full hover:bg-emerald-700 font-bold shadow-lg shadow-emerald-200 transition">Generate</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
                            <h3 class="font-bold text-gray-700">Recent Transactions</h3>
                            <button onclick="loadFinance()" class="text-emerald-600 hover:text-emerald-800"><i class="fas fa-sync"></i></button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-gray-100 text-gray-600">
                                    <tr>
                                        <th class="p-4">Receipt #</th>
                                        <th class="p-4">Student</th>
                                        <th class="p-4">Amount</th>
                                        <th class="p-4">Date</th>
                                        <th class="p-4">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="transaction-history" class="divide-y divide-gray-100">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Timetable View -->
                <div id="view-timetable" class="view-section hidden animate-fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Timetable Management</h2>
                        <button onclick="printTimetable()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 shadow-lg shadow-blue-200"><i class="fas fa-print mr-2"></i> Print Timetable</button>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-6 flex flex-wrap items-center gap-4">
                        <div>
                            <label class="font-bold text-gray-600 block text-xs uppercase mb-1">Select Class:</label>
                            <select id="timetable-class" class="border p-2 rounded-lg outline-none focus:ring-2 focus:ring-blue-200 class-dropdown" onchange="renderTimetable()">
                                <!-- Dynamic options -->
                            </select>
                        </div>
                        <div class="ml-auto flex gap-3">
                             <button onclick="addTimetableCol()" class="text-sm bg-emerald-100 text-emerald-700 px-3 py-1 rounded hover:bg-emerald-200 font-medium">+ Add Period</button>
                             <button onclick="removeTimetableCol()" class="text-sm bg-red-100 text-red-700 px-3 py-1 rounded hover:bg-red-200 font-medium">- Remove Period</button>
                        </div>
                    </div>

                    <div class="overflow-x-auto bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                        <div id="timetable-editor-container">
                            <!-- Dynamic Table -->
                        </div>
                    </div>
                    <button onclick="saveTimetable()" class="mt-6 bg-emerald-600 text-white px-8 py-3 rounded-lg float-right hover:bg-emerald-700 font-bold shadow-lg shadow-emerald-200 transition">Save Timetable Changes</button>
                </div>

            </div>

            <!-- Footer -->
            <footer class="bg-white border-t p-4 text-center text-xs text-gray-400">
                <p>&copy; 2025 Nurul Bayan Science Academy. All Rights Reserved.</p>
                <p class="mt-1 font-bold text-emerald-600/80">Developed by Abu-Abdurrahman CodeVerge Technology | +2348107907647</p>
            </footer>

        </main>
    </div>

    <!-- PRINT AREA (Initially Empty) -->
    <div id="print-area"></div>

    <!-- MODALS -->
    
    <!-- Student Modal -->
    <div id="student-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-8 animate-fade-in">
            <h3 class="text-2xl font-bold mb-6 text-gray-800" id="student-modal-title">Add Student</h3>
            <form id="student-form" class="space-y-4">
                <input type="hidden" id="student-id">
                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-1">Full Name</label>
                    <input type="text" id="student-name" placeholder="Surname Firstname Othername" class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-emerald-200 outline-none" required>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-1">Class</label>
                    <select id="student-class" class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-emerald-200 outline-none class-dropdown" required>
                        <!-- Dynamic -->
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-1">Student Photo</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:bg-gray-50 cursor-pointer relative">
                        <input type="file" id="student-photo-input" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="previewImage(this)">
                        <p class="text-gray-500 text-sm"><i class="fas fa-cloud-upload-alt mr-2"></i>Click to upload photo</p>
                    </div>
                    <img id="student-photo-preview" class="w-24 h-24 object-cover mt-4 rounded-lg border-2 border-emerald-500 hidden mx-auto shadow-md">
                </div>
                <div class="flex justify-end gap-3 mt-8">
                    <button type="button" onclick="closeModal('student-modal')" class="px-5 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
                    <button type="submit" class="px-5 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 shadow-md">Save Student</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Subject Management Modal -->
    <div id="subject-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-8 animate-fade-in h-3/4 flex flex-col">
            <h3 class="text-2xl font-bold mb-4 text-gray-800">Manage Subjects</h3>
            <div class="flex gap-2 mb-4">
                <input type="text" id="new-subject-input" placeholder="Enter new subject name..." class="flex-1 border p-2 rounded-lg focus:outline-none focus:border-blue-500">
                <button onclick="addNewSubject()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"><i class="fas fa-plus"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto border rounded-lg p-2 bg-gray-50" id="subject-list-container">
                <!-- JS Populated -->
            </div>
            <div class="mt-4 flex justify-end">
                <button onclick="closeModal('subject-modal')" class="px-5 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Close</button>
            </div>
        </div>
    </div>

    <!-- Score Modal -->
    <div id="score-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl h-[90vh] flex flex-col p-6 animate-fade-in">
            <div class="flex justify-between items-center mb-4 pb-4 border-b">
                <div>
                    <h3 class="text-2xl font-bold text-gray-800">Score Sheet</h3>
                    <p id="score-modal-subtitle" class="text-sm text-gray-500 mt-1"></p>
                </div>
                <button onclick="closeModal('score-modal')" class="text-gray-400 hover:text-red-500 text-2xl"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="overflow-y-auto flex-1 border rounded-xl shadow-inner bg-gray-50">
                <table class="w-full text-sm">
                    <thead class="bg-emerald-800 text-white sticky top-0 z-10">
                        <tr>
                            <th class="p-4 text-left">Student Name</th>
                            <th class="p-4 w-24 text-center">CA 1 (20)</th>
                            <th class="p-4 w-24 text-center">CA 2 (20)</th>
                            <th class="p-4 w-24 text-center">Exam (60)</th>
                            <th class="p-4 w-20 text-center">Total</th>
                            <th class="p-4 w-20 text-center">Grade</th>
                        </tr>
                    </thead>
                    <tbody id="score-input-list" class="divide-y divide-gray-200 bg-white">
                        <!-- Populated dynamically -->
                    </tbody>
                </table>
            </div>

            <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                <button onclick="closeModal('score-modal')" class="px-6 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium">Cancel</button>
                <button onclick="saveScores()" class="px-6 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 shadow-lg shadow-emerald-200 font-bold">Save All Scores</button>
            </div>
        </div>
    </div>

    <!-- Firebase & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyB3nMQMbc_nlQqcKUEsH-puraiUzrXQLY0",
            authDomain: "nurul-bayan-science-academy.firebaseapp.com",
            projectId: "nurul-bayan-science-academy",
            storageBucket: "nurul-bayan-science-academy.firebasestorage.app",
            messagingSenderId: "86444557578",
            appId: "1:86444557578:web:ec17056fa02214e4b126f3",
            measurementId: "G-NQ2Q9RLLSC"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // DATA STATE
        let currentUser = localStorage.getItem('nbsa_user');
        let studentsData = [];
        // Default subjects fallback
        let subjectsList = [
            "Mathematics", "English Language", "Basic Science", "Basic Technology", "Civic Education", 
            "Islamic Studies", "Arabic", "Hausa", "Computer Studies", "Agricultural Science", 
            "Social Studies", "Biology", "Physics", "Chemistry", "Geography", "Economics",
            "Verbal Reasoning", "Quantitative Reasoning", "Phonics", "Rhymes", "Writing", "Quran", "Hadith", "Fiqh", "Seerah"
        ];
        
        // Expanded Class List
        const classList = [
            "Pre-Nursery", "Nursery 1", "Nursery 2", 
            "Primary 1", "Primary 2", "Primary 3", "Primary 4", "Primary 5", "Primary 6",
            "JSS 1", "JSS 2", "JSS 3", 
            "SSS 1", "SSS 2", "SSS 3",
            "Islamiyya"
        ];

        // --- AUTHENTICATION ---
        window.checkAuth = () => {
            if (currentUser === 'Edu') {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                initApp();
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
            }
        }

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            if (u === 'Edu' && p === 'Edu123') {
                localStorage.setItem('nbsa_user', 'Edu');
                currentUser = 'Edu';
                checkAuth();
            } else {
                alert('Invalid Credentials');
            }
        });

        window.logout = () => {
            localStorage.removeItem('nbsa_user');
            location.reload();
        }

        // --- INITIALIZATION ---
        async function initApp() {
            await loadSubjects();
            populateClassDropdowns();
            loadDashboard();
        }

        // Populate all class select elements
        function populateClassDropdowns() {
            const selects = document.querySelectorAll('.class-dropdown, #filter-class');
            selects.forEach(sel => {
                const currentVal = sel.value; // preserve value if possible
                let html = sel.id === 'filter-class' ? '<option value="All">All Classes</option>' : '<option value="">Select Class</option>';
                classList.forEach(c => html += `<option value="${c}">${c}</option>`);
                sel.innerHTML = html;
                if(currentVal) sel.value = currentVal;
            });
        }

        // --- SUBJECT MANAGEMENT ---
        async function loadSubjects() {
            try {
                const docRef = doc(db, "settings", "academics");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists() && docSnap.data().subjects) {
                    subjectsList = docSnap.data().subjects;
                } else {
                    // Initialize if not exists
                    await setDoc(docRef, { subjects: subjectsList });
                }
                populateSubjectDropdowns();
            } catch (e) {
                console.log("Using default subjects or local cache", e);
                populateSubjectDropdowns();
            }
        }

        function populateSubjectDropdowns() {
            const sel = document.getElementById('score-subject-select');
            if(sel) {
                sel.innerHTML = '';
                subjectsList.sort().forEach(s => sel.innerHTML += `<option value="${s}">${s}</option>`);
            }
        }

        window.renderSubjectManager = () => {
            const container = document.getElementById('subject-list-container');
            container.innerHTML = '';
            subjectsList.sort().forEach((s, idx) => {
                container.innerHTML += `
                    <div class="flex justify-between items-center p-2 border-b last:border-0 hover:bg-white transition">
                        <span>${s}</span>
                        <button onclick="removeSubject('${s}')" class="text-red-500 hover:text-red-700 px-2"><i class="fas fa-trash"></i></button>
                    </div>
                `;
            });
        }

        window.addNewSubject = async () => {
            const input = document.getElementById('new-subject-input');
            const val = input.value.trim();
            if(val && !subjectsList.includes(val)) {
                subjectsList.push(val);
                await updateSubjectList();
                input.value = '';
                renderSubjectManager();
                populateSubjectDropdowns();
            }
        }

        window.removeSubject = async (sub) => {
            if(confirm(`Remove ${sub}?`)) {
                subjectsList = subjectsList.filter(s => s !== sub);
                await updateSubjectList();
                renderSubjectManager();
                populateSubjectDropdowns();
            }
        }

        async function updateSubjectList() {
            try {
                await setDoc(doc(db, "settings", "academics"), { subjects: subjectsList });
            } catch(e) { alert("Error saving subjects"); }
        }

        // --- NAVIGATION ---
        window.nav = (viewId) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${viewId}`).classList.remove('hidden');
            
            // Active state
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('bg-emerald-700/50', 'shadow-inner');
            });
            // Simple active check logic based on click context usually handles this, 
            // but for robustness in single-page, we just ensure the view shows.
            
            if(viewId === 'students') renderStudents();
            if(viewId === 'finance') loadFinance();
            if(viewId === 'timetable') renderTimetable();
        }

        window.toggleMobileMenu = () => {
            document.getElementById('mobile-menu').classList.toggle('hidden');
        }

        window.previewImage = (input) => {
            if(input.files && input.files[0]){
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.getElementById('student-photo-preview');
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- CORE LOGIC (CRUD) ---
        async function loadDashboard() {
            const querySnapshot = await getDocs(collection(db, "students"));
            studentsData = [];
            querySnapshot.forEach((doc) => {
                studentsData.push({ id: doc.id, ...doc.data() });
            });
            document.getElementById('dash-total-students').innerText = studentsData.length;
            document.getElementById('dash-total-classes').innerText = classList.length;

            const receiptSelect = document.getElementById('receipt-student-select');
            receiptSelect.innerHTML = '<option value="">Select Student...</option>';
            studentsData.sort((a,b) => a.name.localeCompare(b.name)).forEach(s => {
                receiptSelect.innerHTML += `<option value="${s.id}">${s.name} (${s.class})</option>`;
            });
        }

        window.renderStudents = async () => {
            if(studentsData.length === 0) await loadDashboard();
            const tbody = document.getElementById('student-list-body');
            const search = document.getElementById('search-student').value.toLowerCase();
            const filter = document.getElementById('filter-class').value;

            tbody.innerHTML = '';
            
            const filtered = studentsData.filter(s => {
                const matchesName = s.name.toLowerCase().includes(search);
                const matchesClass = filter === 'All' || s.class === filter;
                return matchesName && matchesClass;
            });

            filtered.forEach(s => {
                tbody.innerHTML += `
                    <tr class="border-b hover:bg-emerald-50/30 transition">
                        <td class="p-4"><img src="${s.photo || 'https://via.placeholder.com/50'}" class="w-10 h-10 rounded-full object-cover border-2 border-emerald-100"></td>
                        <td class="p-4 font-semibold text-gray-700">${s.name}</td>
                        <td class="p-4"><span class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-xs font-bold border">${s.class}</span></td>
                        <td class="p-4 text-center">
                            <button onclick="editStudent('${s.id}')" class="text-blue-500 hover:text-blue-700 mx-2 transition"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteStudent('${s.id}')" class="text-red-500 hover:text-red-700 mx-2 transition"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>
                `;
            });
        }

        // Image Compressor (Max 100KB)
        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 300;
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7)); 
                    }
                }
            });
        }

        document.getElementById('student-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('student-id').value;
            const name = document.getElementById('student-name').value;
            const sClass = document.getElementById('student-class').value;
            const fileInput = document.getElementById('student-photo-input');
            
            let photoBase64 = null;
            if (fileInput.files.length > 0) {
                photoBase64 = await compressImage(fileInput.files[0]);
            } else if (id) {
                const existing = studentsData.find(s => s.id === id);
                photoBase64 = existing.photo;
            }

            const data = { name, class: sClass, photo: photoBase64 };
            
            try {
                if (id) {
                    await updateDoc(doc(db, "students", id), data);
                    alert('Student Updated');
                } else {
                    await addDoc(collection(db, "students"), { ...data, scores: {}, payments: [] });
                    alert('Student Added');
                }
                closeModal('student-modal');
                loadDashboard(); 
                renderStudents();
            } catch (err) {
                console.error(err);
                alert("Error saving student");
            }
        });

        window.editStudent = (id) => {
            const s = studentsData.find(st => st.id === id);
            document.getElementById('student-id').value = s.id;
            document.getElementById('student-name').value = s.name;
            document.getElementById('student-class').value = s.class;
            document.getElementById('student-photo-preview').src = s.photo || '';
            document.getElementById('student-photo-preview').classList.remove('hidden');
            document.getElementById('student-modal-title').innerText = "Edit Student";
            openModal('student-modal');
        }

        window.deleteStudent = async (id) => {
            if(confirm('Delete student? Action is irreversible.')) {
                await deleteDoc(doc(db, "students", id));
                loadDashboard();
                renderStudents();
            }
        }

        // --- SCORES ---
        window.loadClassForScores = () => {
            const cls = document.getElementById('score-class-select').value;
            const area = document.getElementById('score-entry-area');
            if(cls) area.classList.remove('hidden');
            else area.classList.add('hidden');
        }

        window.openScoreModal = () => {
            const cls = document.getElementById('score-class-select').value;
            const subj = document.getElementById('score-subject-select').value;
            const term = document.getElementById('score-term-select').value;
            
            if(!cls) return;

            document.getElementById('score-modal-subtitle').innerText = `Class: ${cls} • Subject: ${subj} • Term: ${term}`;
            const tbody = document.getElementById('score-input-list');
            tbody.innerHTML = '';

            const classStudents = studentsData.filter(s => s.class === cls);
            classStudents.sort((a,b) => a.name.localeCompare(b.name));

            classStudents.forEach(s => {
                const studentScores = s.scores || {};
                const subjScores = studentScores[subj] || {};
                const termScore = subjScores[term] || { ca1:0, ca2:0, exam:0 };
                
                const total = Number(termScore.ca1) + Number(termScore.ca2) + Number(termScore.exam);

                tbody.innerHTML += `
                    <tr data-id="${s.id}" class="hover:bg-gray-50">
                        <td class="p-3 font-semibold text-gray-700">${s.name}</td>
                        <td class="p-2 text-center"><input type="number" class="w-full border p-2 rounded text-center ca1 focus:ring-1 focus:ring-blue-500 outline-none" max="20" value="${termScore.ca1}" oninput="calcRow(this)"></td>
                        <td class="p-2 text-center"><input type="number" class="w-full border p-2 rounded text-center ca2 focus:ring-1 focus:ring-blue-500 outline-none" max="20" value="${termScore.ca2}" oninput="calcRow(this)"></td>
                        <td class="p-2 text-center"><input type="number" class="w-full border p-2 rounded text-center exam focus:ring-1 focus:ring-blue-500 outline-none" max="60" value="${termScore.exam}" oninput="calcRow(this)"></td>
                        <td class="p-3 font-bold text-center total text-blue-600">${total}</td>
                        <td class="p-3 font-bold text-center grade text-gray-500">${getGrade(total)}</td>
                    </tr>
                `;
            });

            openModal('score-modal');
        }

        window.calcRow = (input) => {
            const row = input.closest('tr');
            const ca1 = Number(row.querySelector('.ca1').value) || 0;
            const ca2 = Number(row.querySelector('.ca2').value) || 0;
            const exam = Number(row.querySelector('.exam').value) || 0;
            const total = ca1 + ca2 + exam;
            row.querySelector('.total').innerText = total;
            row.querySelector('.grade').innerText = getGrade(total);
        }

        window.saveScores = async () => {
            const cls = document.getElementById('score-class-select').value;
            const subj = document.getElementById('score-subject-select').value;
            const term = document.getElementById('score-term-select').value;
            const rows = document.querySelectorAll('#score-input-list tr');
            
            const updates = [];

            for (let row of rows) {
                const id = row.getAttribute('data-id');
                const ca1 = Number(row.querySelector('.ca1').value);
                const ca2 = Number(row.querySelector('.ca2').value);
                const exam = Number(row.querySelector('.exam').value);

                const student = studentsData.find(s => s.id === id);
                if (!student.scores) student.scores = {};
                if (!student.scores[subj]) student.scores[subj] = {};
                
                student.scores[subj][term] = { ca1, ca2, exam };
                updates.push(updateDoc(doc(db, "students", id), { scores: student.scores }));
            }

            try {
                await Promise.all(updates);
                alert('Scores Saved!');
                closeModal('score-modal');
            } catch (e) {
                console.error(e);
                alert('Error saving scores');
            }
        }

        // --- REPORT CARD ---
        const getGrade = (score) => {
            if(score >= 70) return 'A';
            if(score >= 60) return 'B';
            if(score >= 50) return 'C';
            if(score >= 45) return 'D';
            if(score >= 40) return 'E';
            return 'F';
        }

        const getPositionTier = (avg) => {
            if (avg >= 90) return "1st Distinction";
            if (avg >= 85) return "1st Upper";
            if (avg >= 80) return "1st Standard";
            if (avg >= 75) return "2nd Upper";
            if (avg >= 70) return "2nd Standard";
            if (avg >= 60) return "3rd Standard";
            if (avg >= 50) return "Pass";
            return "Fail";
        }

        const getPrincipalComment = (avg) => {
            if (avg >= 90) return "An outstanding result! Keep soaring high.";
            if (avg >= 80) return "Excellent performance. You are a star.";
            if (avg >= 70) return "Very good result. Consistency is key.";
            if (avg >= 60) return "Good attempt. Strive for excellence next time.";
            if (avg >= 50) return "Average performance. More effort is needed.";
            return "Poor performance. Please wake up and study hard.";
        }

        window.generateBulkReports = () => {
            const cls = document.getElementById('score-class-select').value;
            const term = document.getElementById('score-term-select').value;
            const nextTerm = document.getElementById('next-term-date').value;

            if(!cls || !nextTerm) { alert("Select Class and Date"); return; }
            const students = studentsData.filter(s => s.class === cls);
            if(students.length === 0) { alert("No students found"); return; }

            // Prep Data
            const reportData = students.map(s => {
                let totalScore = 0;
                let subjectCount = 0;
                const subjects = [];
                if(s.scores) {
                    for(let [subjName, terms] of Object.entries(s.scores)) {
                        if(terms[term]) {
                            const t = terms[term];
                            const tot = Number(t.ca1) + Number(t.ca2) + Number(t.exam);
                            totalScore += tot;
                            subjectCount++;
                            subjects.push({ name: subjName, ...t, total: tot, grade: getGrade(tot) });
                        }
                    }
                }
                const average = subjectCount > 0 ? (totalScore / subjectCount).toFixed(2) : 0;
                return { ...s, average: Number(average), totalScore, subjects, subjectCount };
            });

            reportData.sort((a, b) => b.average - a.average);

            const printArea = document.getElementById('print-area');
            printArea.innerHTML = '';

            reportData.forEach((s, index) => {
                const qrId = `qrcode-${s.id}`;
                let subjectsRows = '';
                
                // Define standard layout for rows
                const rowHeight = Math.max(25, 500 / (s.subjects.length || 1)); 

                s.subjects.forEach(sub => {
                    subjectsRows += `
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 6px; border-right: 1px solid #e5e7eb;">${sub.name}</td>
                            <td style="padding: 6px; text-align: center; border-right: 1px solid #e5e7eb;">${sub.ca1}</td>
                            <td style="padding: 6px; text-align: center; border-right: 1px solid #e5e7eb;">${sub.ca2}</td>
                            <td style="padding: 6px; text-align: center; border-right: 1px solid #e5e7eb;">${sub.exam}</td>
                            <td style="padding: 6px; text-align: center; font-weight: bold; border-right: 1px solid #e5e7eb;">${sub.total}</td>
                            <td style="padding: 6px; text-align: center; font-weight: bold; color: ${sub.grade === 'F' ? 'red' : 'green'};">${sub.grade}</td>
                        </tr>
                    `;
                });

                const html = `
                <div class="report-card-page" style="font-family: 'Poppins', sans-serif; position: relative;">
                    <!-- Watermark -->
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0.05; width: 400px; height: 400px; background-image: url('https://placehold.co/400x400?text=NB'); background-size: contain; background-repeat: no-repeat; z-index: 0;"></div>

                    <!-- Border Frame -->
                    <div style="width: 100%; height: 100%; padding: 10mm; box-sizing: border-box; border: 4px double #065f46; position: relative; z-index: 1;">
                        
                        <!-- Header -->
                        <div style="display: flex; gap: 15px; border-bottom: 3px solid #065f46; padding-bottom: 10px; margin-bottom: 10px; align-items: center;">
                            <div style="width: 80px; height: 80px; background: #065f46; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 24px;">NB</div>
                            <div style="flex: 1; text-align: center;">
                                <h1 style="font-size: 26px; font-weight: 800; color: #065f46; margin: 0; line-height: 1;">NURUL BAYAN SCIENCE ACADEMY</h1>
                                <h2 style="font-family: 'Noto Naskh Arabic', serif; font-size: 18px; color: #065f46; margin: 2px 0;">نور البيان الأكاديمية للعلوم</h2>
                                <p style="font-size: 11px; margin: 0; color: #333;">2222 Janbulo Housing Estate, Opposite Afforestation, Dorayi Babba, Gwale LGA, Kano</p>
                                <p style="font-size: 11px; margin: 0; color: #333;"><b>Motto:</b> Knowledge is the Root of Success</p>
                            </div>
                            <div id="${qrId}"></div>
                        </div>

                        <div style="background: #065f46; color: white; text-align: center; padding: 5px; font-weight: bold; text-transform: uppercase; font-size: 14px; margin-bottom: 15px;">Student Terminal Report</div>

                        <!-- Bio Data -->
                        <div style="display: flex; gap: 20px; margin-bottom: 15px; border: 1px solid #ccc; padding: 10px; background: #f9f9f9;">
                            <img src="${s.photo || 'https://via.placeholder.com/150'}" style="width: 100px; height: 100px; object-fit: cover; border: 2px solid #065f46; border-radius: 5px;">
                            <div style="flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
                                <div><b style="color:#065f46;">NAME:</b> ${s.name.toUpperCase()}</div>
                                <div><b style="color:#065f46;">CLASS:</b> ${s.class.toUpperCase()}</div>
                                <div><b style="color:#065f46;">ADMISSION NO:</b> NB/${s.id.substring(0,4)}</div>
                                <div><b style="color:#065f46;">SESSION:</b> 2025 / 2026</div>
                                <div><b style="color:#065f46;">TERM:</b> ${term.toUpperCase()}</div>
                                <div><b style="color:#065f46;">CLASS SIZE:</b> ${students.length}</div>
                            </div>
                            <div style="text-align: center; border-left: 1px solid #ccc; padding-left: 15px; display: flex; flex-col; justify-content: center; align-items: center;">
                                <div style="font-size: 32px; font-weight: 800; color: #065f46;">${index+1}<span style="font-size: 14px; vertical-align: super;">/${students.length}</span></div>
                                <div style="font-size: 10px; text-transform: uppercase; font-weight: bold;">Position</div>
                            </div>
                        </div>

                        <!-- Scores -->
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px; border: 1px solid #065f46;">
                            <thead style="background: #065f46; color: white;">
                                <tr>
                                    <th style="padding: 8px; text-align: left;">SUBJECT</th>
                                    <th style="padding: 8px; width: 40px;">CA1</th>
                                    <th style="padding: 8px; width: 40px;">CA2</th>
                                    <th style="padding: 8px; width: 40px;">EXAM</th>
                                    <th style="padding: 8px; width: 50px;">TOTAL</th>
                                    <th style="padding: 8px; width: 50px;">GRADE</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${subjectsRows}
                            </tbody>
                            <tfoot style="background: #f0fdf4; font-weight: bold;">
                                <tr>
                                    <td colspan="4" style="padding: 8px; text-align: right;">OVERALL TOTAL:</td>
                                    <td colspan="2" style="padding: 8px; text-align: center; color: #065f46;">${s.totalScore}</td>
                                </tr>
                                <tr>
                                    <td colspan="4" style="padding: 8px; text-align: right;">AVERAGE:</td>
                                    <td colspan="2" style="padding: 8px; text-align: center; color: #065f46;">${s.average}%</td>
                                </tr>
                            </tfoot>
                        </table>

                        <!-- Remarks & Footer -->
                        <div style="margin-top: auto; padding-top: 10px;">
                            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px; margin-bottom: 20px;">
                                <div style="border: 1px solid #ccc; padding: 10px; font-size: 12px;">
                                    <div style="font-weight: bold; color: #065f46; margin-bottom: 5px;">PRINCIPAL'S REMARK:</div>
                                    <div style="font-family: 'Times New Roman', serif; font-style: italic;">"${getPrincipalComment(s.average)}"</div>
                                </div>
                                <div style="border: 1px solid #ccc; padding: 10px; font-size: 12px;">
                                    <div style="font-weight: bold; color: #065f46; margin-bottom: 5px;">NEXT TERM BEGINS:</div>
                                    <div>${new Date(nextTerm).toLocaleDateString()}</div>
                                </div>
                            </div>

                            <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-top: 10px;">
                                <div>
                                    <div style="font-size: 10px; font-weight: bold;">GRADING SYSTEM:</div>
                                    <div style="font-size: 9px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px;">
                                        <span>70-100: A (Excellent)</span>
                                        <span>60-69: B (V. Good)</span>
                                        <span>50-59: C (Credit)</span>
                                        <span>45-49: D (Pass)</span>
                                        <span>40-44: E (Fair)</span>
                                        <span>0-39: F (Fail)</span>
                                    </div>
                                </div>
                                <div style="text-align: center; position: relative;">
                                    <div class="school-stamp" style="width: 90px; height: 90px; font-size: 9px; border: 3px double #065f46; color: #065f46; border-radius: 50%; display: flex; align-items: center; justify-content: center; text-align: center; transform: rotate(-15deg); position: absolute; bottom: 10px; right: 0; opacity: 0.8; background: rgba(255,255,255,0.8);">
                                        OFFICIAL<br>STAMP<br>&<br>SIGNED
                                    </div>
                                    <div style="border-top: 1px solid black; width: 150px; margin-top: 50px; padding-top: 5px; font-size: 11px; font-weight: bold;">Principal's Signature</div>
                                </div>
                            </div>
                        </div>

                        <div style="position: absolute; bottom: 5mm; left: 0; width: 100%; text-align: center; font-size: 9px; color: #666;">
                            Generated by CodeVerge Technology | +2348107907647 | Valid Report Card
                        </div>
                    </div>
                </div>
                `;
                printArea.innerHTML += html;
                setTimeout(() => {
                    new QRCode(document.getElementById(qrId), {
                        text: `NBSA-VERIFY-${s.id}-${term}-${s.average}`,
                        width: 50,
                        height: 50,
                        colorDark : "#065f46",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });
                }, 100);
            });
            window.print();
        }

        window.exportToExcel = () => {
            const cls = document.getElementById('score-class-select').value;
            if(!cls) return alert("Select Class");
            const ws_data = [
                ["NURUL BAYAN SCIENCE ACADEMY"],
                [`Class: ${cls}`, "Session: 2025/2026"],
                [],
                ["Name", "Subject", "CA1", "CA2", "Exam", "Total", "Grade"]
            ];
            const students = studentsData.filter(s => s.class === cls);
            students.forEach(s => {
                const term = document.getElementById('score-term-select').value;
                if(s.scores) {
                    for(let [subj, terms] of Object.entries(s.scores)) {
                        if(terms[term]) {
                            const tot = terms[term].ca1 + terms[term].ca2 + terms[term].exam;
                            ws_data.push([
                                s.name, subj, terms[term].ca1, terms[term].ca2, terms[term].exam, tot, getGrade(tot)
                            ]);
                        }
                    }
                }
            });
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "Broadsheet");
            XLSX.writeFile(wb, `${cls}_Broadsheet.xlsx`);
        }

        // --- FINANCE ---
        window.loadFinance = () => {
            const historyBody = document.getElementById('transaction-history');
            historyBody.innerHTML = '';
            let allPayments = [];
            studentsData.forEach(s => {
                if(s.payments) {
                    s.payments.forEach(p => allPayments.push({...p, studentName: s.name, studentId: s.id, class: s.class}));
                }
            });
            allPayments.sort((a,b) => new Date(b.date) - new Date(a.date));
            allPayments.forEach(p => {
                historyBody.innerHTML += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-4 font-mono text-xs text-gray-500">${p.id}</td>
                        <td class="p-4 font-medium">${p.studentName}</td>
                        <td class="p-4 font-bold text-emerald-600">₦${Number(p.amount).toLocaleString()}</td>
                        <td class="p-4 text-xs text-gray-500">${p.date}</td>
                        <td class="p-4"><button onclick="reprintReceipt('${p.studentId}', '${p.id}')" class="text-blue-600 hover:text-blue-800 text-xs font-bold border border-blue-200 px-2 py-1 rounded">PRINT</button></td>
                    </tr>
                `;
            });
        }

        window.generateReceipt = async () => {
            const studentId = document.getElementById('receipt-student-select').value;
            const amount = document.getElementById('receipt-amount').value;
            const desc = document.getElementById('receipt-desc').value;
            const term = document.getElementById('receipt-term').value;

            if(!studentId || !amount || !desc) { alert("Fill all fields"); return; }

            const receiptId = 'RCPT-' + Math.floor(100000 + Math.random() * 900000);
            const dateStr = new Date().toLocaleDateString('en-GB');
            
            const payment = { id: receiptId, amount: amount, desc: desc, term: term, date: dateStr };
            const student = studentsData.find(s => s.id === studentId);
            if(!student.payments) student.payments = [];
            student.payments.push(payment);

            try {
                await updateDoc(doc(db, "students", studentId), { payments: student.payments });
                alert("Success");
                loadFinance();
                printReceiptLayout(student, payment);
            } catch(e) {
                alert("Error");
            }
        }

        window.reprintReceipt = (studentId, receiptId) => {
            const student = studentsData.find(s => s.id === studentId);
            const payment = student.payments.find(p => p.id === receiptId);
            printReceiptLayout(student, payment);
        }

        const printReceiptLayout = (student, payment) => {
            const printArea = document.getElementById('print-area');
            const html = `
                <div style="width: 210mm; height: 148mm; margin: 0 auto; padding: 15mm; font-family: 'Poppins', sans-serif; position: relative; box-sizing: border-box; background: white;">
                    <div style="border: 2px solid #065f46; height: 100%; padding: 10mm; position: relative; border-radius: 10px;">
                        
                         <!-- Watermark -->
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg); font-size: 80px; font-weight: 900; color: #f0fdf4; z-index: -1;">PAID</div>

                        <div style="text-align: center; border-bottom: 2px dashed #065f46; padding-bottom: 5mm; margin-bottom: 5mm;">
                             <h1 style="margin: 0; font-size: 22px; color: #065f46; font-weight: 800;">NURUL BAYAN SCIENCE ACADEMY</h1>
                             <p style="margin: 2px 0; font-size: 10px; color: #555;">Official School Fees Receipt</p>
                        </div>

                        <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 10mm;">
                            <div>
                                <p style="margin: 3px 0;"><b>Receipt No:</b> <span style="font-family: monospace; font-size: 14px;">${payment.id}</span></p>
                                <p style="margin: 3px 0;"><b>Date:</b> ${payment.date}</p>
                            </div>
                            <div style="text-align: right;">
                                <p style="margin: 3px 0;"><b>Session:</b> 2025/2026</p>
                                <p style="margin: 3px 0;"><b>Term:</b> ${payment.term}</p>
                            </div>
                        </div>

                        <div style="background: #f0fdf4; padding: 5mm; border-radius: 5px; border: 1px solid #d1fae5; font-size: 13px;">
                            <div style="display: grid; grid-template-columns: 100px 1fr; gap: 10px; margin-bottom: 8px;">
                                <span style="font-weight: bold; color: #065f46;">Received From:</span>
                                <span style="border-bottom: 1px dotted #999;">${student.name.toUpperCase()} (${student.class})</span>
                            </div>
                            <div style="display: grid; grid-template-columns: 100px 1fr; gap: 10px; margin-bottom: 8px;">
                                <span style="font-weight: bold; color: #065f46;">The Sum Of:</span>
                                <span style="border-bottom: 1px dotted #999; font-weight: bold;">₦${Number(payment.amount).toLocaleString()}.00</span>
                            </div>
                            <div style="display: grid; grid-template-columns: 100px 1fr; gap: 10px;">
                                <span style="font-weight: bold; color: #065f46;">Being Payment For:</span>
                                <span style="border-bottom: 1px dotted #999;">${payment.desc}</span>
                            </div>
                        </div>

                        <div style="margin-top: 15mm; display: flex; justify-content: space-between; align-items: flex-end;">
                            <div style="text-align: center;">
                                <div style="border-bottom: 1px solid black; width: 40mm; margin-bottom: 2mm;"></div>
                                <div style="font-size: 10px;">Bursar's Signature</div>
                            </div>
                            
                            <div style="border: 2px solid #065f46; padding: 2mm 5mm; font-weight: bold; color: #065f46; transform: rotate(-5deg); border-radius: 5px; font-size: 16px;">
                                PAID ✔
                            </div>

                             <div style="text-align: center;">
                                <div style="border-bottom: 1px solid black; width: 40mm; margin-bottom: 2mm;"></div>
                                <div style="font-size: 10px;">Payer's Signature</div>
                            </div>
                        </div>

                        <div style="position: absolute; bottom: 3mm; left: 0; width: 100%; text-align: center; font-size: 8px; color: #999;">
                            Electronic Receipt Generated by CodeVerge Technology
                        </div>
                    </div>
                </div>
            `;
            printArea.innerHTML = html;
            window.print();
        }

        // --- TIMETABLE ---
        let timetableData = { "JSS 1": { periods: ["1", "2", "3", "Break", "4", "5"], days: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"], data: {} } };

        window.renderTimetable = () => {
            const cls = document.getElementById('timetable-class').value;
            if(!cls) return;
            if(!timetableData[cls]) timetableData[cls] = { periods: ["1", "2", "3", "Break", "4", "5"], days: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"], data: {} };
            
            const t = timetableData[cls];
            let html = `<table class="w-full border-collapse border border-gray-200 text-sm">`;
            html += `<thead><tr class="bg-emerald-700 text-white"><th class="border p-3 w-32">Day</th>`;
            t.periods.forEach((p, idx) => {
                html += `<th class="border p-3" contenteditable="true" onblur="updatePeriodName('${cls}', ${idx}, this.innerText)">${p}</th>`;
            });
            html += `</tr></thead><tbody>`;

            t.days.forEach(d => {
                html += `<tr><td class="font-bold border p-3 bg-gray-50 text-emerald-800">${d}</td>`;
                t.periods.forEach((p, idx) => {
                    const key = `${d}-${idx}`;
                    html += `<td class="border p-3 text-center hover:bg-yellow-50 focus-within:bg-yellow-100 outline-none" contenteditable="true" onblur="updateTimeCell('${cls}', '${key}', this.innerText)">${t.data[key] || ""}</td>`;
                });
                html += `</tr>`;
            });
            html += `</tbody></table>`;
            document.getElementById('timetable-editor-container').innerHTML = html;
        }

        window.updatePeriodName = (cls, idx, val) => { timetableData[cls].periods[idx] = val; }
        window.updateTimeCell = (cls, key, val) => { timetableData[cls].data[key] = val; }
        
        window.addTimetableCol = () => {
            const cls = document.getElementById('timetable-class').value;
            if(timetableData[cls]) { timetableData[cls].periods.push("New"); renderTimetable(); }
        }
        window.removeTimetableCol = () => {
            const cls = document.getElementById('timetable-class').value;
            if(timetableData[cls]) { timetableData[cls].periods.pop(); renderTimetable(); }
        }
        window.saveTimetable = () => {
             localStorage.setItem('nbsa_timetables', JSON.stringify(timetableData));
             alert('Timetable Saved');
        }

        window.printTimetable = () => {
            const cls = document.getElementById('timetable-class').value;
            const htmlContainer = document.getElementById('timetable-editor-container').innerHTML;
            const printArea = document.getElementById('print-area');
            printArea.innerHTML = `
                <div class="timetable-page">
                    <h1 style="text-align:center; font-weight:bold; font-size:24px; margin-bottom:20px; color:#065f46;">NURUL BAYAN SCIENCE ACADEMY - ${cls} TIMETABLE</h1>
                    ${htmlContainer}
                    <div style="margin-top:20px; text-align:center; font-size:12px;">Generated via NBSA Portal</div>
                </div>
            `;
            window.print();
        }

        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        
        const savedTT = localStorage.getItem('nbsa_timetables');
        if(savedTT) timetableData = JSON.parse(savedTT);
        
        checkAuth();
    </script>
</body>
</html>
