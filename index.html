<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nurul Bayan Science Academy - Management System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- SheetJS for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary: #047857; /* Emerald 700 */
            --secondary: #D97706; /* Amber 600 */
            --dark: #064E3B;
            --light: #F0FDF4;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f3f4f6;
            overflow-x: hidden;
        }
        
        .arabic-text {
            font-family: 'Amiri', serif;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #10B981; 
            border-radius: 4px;
        }

        /* Unique Stamp Design */
        .unique-stamp {
            width: 140px;
            height: 140px;
            border: 3px solid var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            color: var(--primary);
            text-align: center;
            transform: rotate(-15deg);
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 0 0 4px white, 0 0 0 6px var(--primary);
            margin: 0 auto;
        }
        .unique-stamp-inner {
            width: 90%;
            height: 90%;
            border: 1px dashed var(--secondary);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 11px;
            line-height: 1.2;
            text-transform: uppercase;
        }
        .unique-stamp-inner span.approved {
            color: var(--secondary);
            font-size: 16px;
            margin: 4px 0;
            border-top: 2px solid var(--secondary);
            border-bottom: 2px solid var(--secondary);
            padding: 2px 10px;
        }

        /* Timetable Styling */
        .tt-header {
            background: linear-gradient(135deg, var(--primary), var(--dark));
            color: white;
            text-transform: uppercase;
            font-weight: bold;
            letter-spacing: 1px;
        }
        .tt-cell {
            transition: all 0.2s;
            position: relative;
        }
        .tt-cell:hover {
            background-color: #ecfdf5;
        }
        .tt-input:focus {
            background-color: #fff;
            box-shadow: inset 0 0 0 2px var(--secondary);
        }

        /* Loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Modal Transitions */
        .modal {
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }
        .modal.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* PRINT STYLES - REVISED FOR BULK */
        @media print {
            @page {
                size: A4 portrait;
                margin: 0; 
            }

            /* Hide EVERYTHING in the main app */
            #app-container, #login-screen, #toast-container, .modal, .no-print {
                display: none !important;
            }

            /* Show ONLY the global print container */
            #global-print-container {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                background: white;
            }

            /* Report Card Page Wrapper */
            .report-page-wrapper {
                page-break-after: always;
                page-break-inside: avoid;
                width: 210mm;
                min-height: 297mm;
                padding: 5mm;
                box-sizing: border-box;
                position: relative;
                overflow: hidden;
            }
            .report-page-wrapper:last-child {
                page-break-after: auto;
            }

            /* Force background colors */
            .bg-emerald-800 { background-color: #065F46 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .bg-emerald-100 { background-color: #D1FAE5 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .bg-emerald-50 { background-color: #ECFDF5 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .text-emerald-800 { color: #065F46 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .text-white { color: #ffffff !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            
            /* Table borders for print */
            table, th, td {
                border: 1px solid #000 !important;
                border-collapse: collapse;
            }
            
            /* QR Code visibility fix */
            .qr-code-img {
                display: block !important;
            }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Notifications -->
    <div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-2"></div>

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-emerald-900 flex items-center justify-center">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition-all hover:scale-105 duration-300 mx-4">
            <div class="text-center mb-6">
                <div class="w-20 h-20 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4 text-emerald-800 text-3xl">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <h1 class="text-2xl font-bold text-emerald-800">Nurul Bayan Academy</h1>
                <p class="text-sm text-gray-500 mt-1">Admin Portal</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="text" id="username" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" placeholder="Enter username">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" placeholder="••••••••">
                </div>
                <button type="submit" class="w-full bg-emerald-700 text-white py-2 rounded-lg font-semibold hover:bg-emerald-800 transition duration-200 shadow-md">
                    Secure Login
                </button>
            </form>
        </div>
    </div>

    <!-- Dashboard Layout -->
    <div id="app-container" class="hidden flex h-screen overflow-hidden">
        
        <!-- Sidebar -->
        <aside id="sidebar" class="bg-emerald-900 text-white w-64 flex-shrink-0 hidden md:flex flex-col transition-all duration-300">
            <div class="p-6 border-b border-emerald-800 flex flex-col items-center">
                <i class="fas fa-school text-4xl text-amber-400 mb-2"></i>
                <h2 class="font-bold text-center leading-tight">NURUL BAYAN<br><span class="text-xs text-emerald-300 font-normal">Science Academy</span></h2>
            </div>
            <nav class="flex-1 overflow-y-auto py-4">
                <ul class="space-y-1">
                    <li><button onclick="nav('dashboard')" class="nav-btn w-full text-left px-6 py-3 hover:bg-emerald-800 flex items-center gap-3 border-l-4 border-transparent active-nav"><i class="fas fa-chart-pie w-5"></i> Dashboard</button></li>
                    <li><button onclick="nav('students')" class="nav-btn w-full text-left px-6 py-3 hover:bg-emerald-800 flex items-center gap-3 border-l-4 border-transparent"><i class="fas fa-user-graduate w-5"></i> Students</button></li>
                    <li><button onclick="nav('subjects')" class="nav-btn w-full text-left px-6 py-3 hover:bg-emerald-800 flex items-center gap-3 border-l-4 border-transparent"><i class="fas fa-book w-5"></i> Subjects</button></li>
                    <li><button onclick="nav('marks')" class="nav-btn w-full text-left px-6 py-3 hover:bg-emerald-800 flex items-center gap-3 border-l-4 border-transparent"><i class="fas fa-edit w-5"></i> Manage Marks</button></li>
                    <li><button onclick="nav('reports')" class="nav-btn w-full text-left px-6 py-3 hover:bg-emerald-800 flex items-center gap-3 border-l-4 border-transparent"><i class="fas fa-print w-5"></i> Report Cards</button></li>
                    <li><button onclick="nav('finance')" class="nav-btn w-full text-left px-6 py-3 hover:bg-emerald-800 flex items-center gap-3 border-l-4 border-transparent"><i class="fas fa-receipt w-5"></i> Receipts</button></li>
                    <li><button onclick="nav('timetable')" class="nav-btn w-full text-left px-6 py-3 hover:bg-emerald-800 flex items-center gap-3 border-l-4 border-transparent"><i class="fas fa-calendar-alt w-5"></i> Timetable</button></li>
                </ul>
            </nav>
            <div class="p-4 border-t border-emerald-800">
                <button onclick="logout()" class="w-full bg-red-600 hover:bg-red-700 py-2 rounded text-sm font-medium transition">Logout</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden bg-gray-50">
            <!-- Header -->
            <header class="bg-white shadow-sm z-20 flex items-center justify-between px-6 py-3 no-print">
                <button id="menu-toggle" class="md:hidden text-emerald-800 text-2xl"><i class="fas fa-bars"></i></button>
                <div class="font-semibold text-gray-700">
                    Session: <span id="current-session-display" class="text-emerald-700">2025/2026</span>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block">
                        <p class="text-sm font-bold text-gray-800">Administrator</p>
                        <p class="text-xs text-gray-500">Nurul Bayan Academy</p>
                    </div>
                    <div class="h-10 w-10 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-700">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
            </header>

            <!-- Views -->
            <div id="main-content" class="flex-1 overflow-x-hidden overflow-y-auto p-4 md:p-6">
                
                <!-- 1. DASHBOARD -->
                <div id="view-dashboard" class="view-section animate-fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Overview</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-emerald-500">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-gray-500 text-sm">Total Students</p>
                                    <h3 class="text-3xl font-bold text-gray-800" id="dash-total-students">0</h3>
                                </div>
                                <div class="bg-emerald-100 p-3 rounded-full text-emerald-600"><i class="fas fa-users"></i></div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-amber-500">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-gray-500 text-sm">Classes</p>
                                    <h3 class="text-3xl font-bold text-gray-800">10</h3>
                                </div>
                                <div class="bg-amber-100 p-3 rounded-full text-amber-600"><i class="fas fa-layer-group"></i></div>
                            </div>
                        </div>
                         <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-gray-500 text-sm">Receipts Issued</p>
                                    <h3 class="text-3xl font-bold text-gray-800" id="dash-total-receipts">0</h3>
                                </div>
                                <div class="bg-blue-100 p-3 rounded-full text-blue-600"><i class="fas fa-file-invoice"></i></div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="font-bold text-gray-700 mb-4">Quick Actions</h3>
                        <div class="flex flex-wrap gap-4">
                            <button onclick="nav('students')" class="px-4 py-2 bg-emerald-50 text-emerald-700 rounded-lg hover:bg-emerald-100 transition">Add Student</button>
                            <button onclick="nav('finance')" class="px-4 py-2 bg-amber-50 text-amber-700 rounded-lg hover:bg-amber-100 transition">New Receipt</button>
                            <button onclick="nav('marks')" class="px-4 py-2 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 transition">Enter Marks</button>
                        </div>
                    </div>
                </div>

                <!-- 2. STUDENTS -->
                <div id="view-students" class="view-section hidden">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <h2 class="text-2xl font-bold text-gray-800">Student Management</h2>
                        <button onclick="openModal('add-student-modal')" class="bg-emerald-600 text-white px-5 py-2 rounded-lg hover:bg-emerald-700 shadow-md transition"><i class="fas fa-plus mr-2"></i> Add Student</button>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div class="p-4 border-b border-gray-100 flex gap-4 flex-wrap">
                             <select id="filter-class-student" class="border rounded-lg px-3 py-2 text-sm w-full md:w-64" onchange="loadStudents()">
                                <option value="All">All Classes</option>
                            </select>
                            <input type="text" id="search-student" placeholder="Search by name..." class="border rounded-lg px-3 py-2 text-sm w-full md:w-64" onkeyup="filterStudentsTable()">
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse min-w-[600px]">
                                <thead class="bg-gray-50 text-gray-600 text-sm uppercase">
                                    <tr>
                                        <th class="p-4">Photo</th>
                                        <th class="p-4">Name</th>
                                        <th class="p-4">Class</th>
                                        <th class="p-4 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="students-table-body" class="text-sm text-gray-700 divide-y divide-gray-100">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 3. SUBJECTS -->
                <div id="view-subjects" class="view-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Subject Allocation</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm h-fit">
                            <h3 class="font-bold text-lg mb-4">Add Subject</h3>
                            <form id="add-subject-form" class="space-y-4">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase">Class</label>
                                    <select id="subject-class" class="w-full border p-2 rounded mt-1 bg-gray-50"></select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase">Subject Name</label>
                                    <input type="text" id="subject-name" class="w-full border p-2 rounded mt-1 bg-gray-50" placeholder="e.g. Mathematics" required>
                                </div>
                                <button type="submit" class="w-full bg-emerald-600 text-white py-2 rounded hover:bg-emerald-700">Add Subject</button>
                            </form>
                        </div>
                        <div class="md:col-span-2 bg-white p-6 rounded-xl shadow-sm">
                            <h3 class="font-bold text-lg mb-4">Subject List</h3>
                            <div class="overflow-y-auto max-h-96">
                                <ul id="subjects-list" class="space-y-2"></ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4. MARKS -->
                <div id="view-marks" class="view-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Marks Entry</h2>
                    <div class="bg-white p-6 rounded-xl shadow-sm mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div>
                                <label class="block text-sm font-bold text-gray-600">Class</label>
                                <select id="marks-class" class="w-full border p-2 rounded mt-1" onchange="loadSubjectsForMarks()"></select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-600">Subject</label>
                                <select id="marks-subject" class="w-full border p-2 rounded mt-1"></select>
                            </div>
                            <button onclick="loadMarksTable()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Load Sheet</button>
                        </div>
                    </div>

                    <div id="marks-entry-container" class="hidden bg-white rounded-xl shadow-sm overflow-hidden">
                        <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
                            <h3 class="font-bold text-gray-700">Score Sheet</h3>
                            <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">Auto-saving disabled. Click Save.</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left min-w-[600px]">
                                <thead class="bg-gray-100 text-gray-700">
                                    <tr>
                                        <th class="p-3">Student Name</th>
                                        <th class="p-3 w-24">CA1 (20)</th>
                                        <th class="p-3 w-24">CA2 (20)</th>
                                        <th class="p-3 w-24">Exam (60)</th>
                                        <th class="p-3 w-24">Total</th>
                                        <th class="p-3 w-24">Grade</th>
                                    </tr>
                                </thead>
                                <tbody id="marks-tbody"></tbody>
                            </table>
                        </div>
                        <div class="p-4 bg-gray-50 border-t text-right">
                             <button onclick="deleteMarksForSubject()" class="mr-4 text-red-600 hover:text-red-800 text-sm font-bold">Clear All Marks for this Subject</button>
                            <button onclick="saveMarks()" class="bg-emerald-600 text-white px-8 py-2 rounded shadow hover:bg-emerald-700">Save All Marks</button>
                        </div>
                    </div>
                </div>

                <!-- 5. REPORTS -->
                <div id="view-reports" class="view-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Report Cards</h2>
                    <div class="bg-white p-6 rounded-xl shadow-sm mb-6 no-print">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div>
                                <label class="block text-sm font-bold text-gray-600">Class</label>
                                <select id="report-class" class="w-full border p-2 rounded mt-1"></select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-600">Term</label>
                                <select id="report-term" class="w-full border p-2 rounded mt-1">
                                    <option value="1st Term">1st Term</option>
                                    <option value="2nd Term">2nd Term</option>
                                    <option value="3rd Term">3rd Term</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-600">Next Term Begins</label>
                                <input type="date" id="next-term-date" class="w-full border p-2 rounded mt-1">
                            </div>
                            <button onclick="generateReportList()" class="bg-emerald-600 text-white px-6 py-2 rounded hover:bg-emerald-700">Generate</button>
                        </div>
                    </div>

                    <div id="report-list-container" class="hidden bg-white rounded-xl shadow-sm p-6 no-print">
                         <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                            <h3 class="font-bold">Class List</h3>
                            <div class="flex gap-2">
                                <button onclick="exportExcel()" class="bg-green-700 text-white px-3 py-1 rounded text-sm"><i class="fas fa-file-excel mr-1"></i> Excel</button>
                                <button onclick="printAllReports()" class="bg-purple-700 text-white px-4 py-2 rounded text-sm font-bold shadow-lg hover:bg-purple-800 transition"><i class="fas fa-print mr-1"></i> BULK PRINT CLASS</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left min-w-[500px]">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-2">Pos</th>
                                        <th class="p-2">Student</th>
                                        <th class="p-2">Avg</th>
                                        <th class="p-2">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="report-list-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 6. FINANCE -->
                <div id="view-finance" class="view-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Receipt Management</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 no-print">
                        <!-- New Receipt Form -->
                        <div class="bg-white p-6 rounded-xl shadow-sm">
                            <h3 class="font-bold text-lg mb-4 text-emerald-800">New Receipt</h3>
                            <form id="receipt-form" class="space-y-3">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500">Class</label>
                                    <select id="receipt-class" class="w-full border p-2 rounded mt-1 bg-gray-50" onchange="updateReceiptStudents()"></select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500">Student</label>
                                    <select id="receipt-student" class="w-full border p-2 rounded mt-1 bg-gray-50"></select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500">Payment For</label>
                                    <input type="text" id="receipt-purpose" class="w-full border p-2 rounded mt-1 bg-gray-50" placeholder="e.g. School Fees" required>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500">Amount (₦)</label>
                                    <input type="number" id="receipt-amount" class="w-full border p-2 rounded mt-1 bg-gray-50" required>
                                </div>
                                 <div>
                                    <label class="block text-xs font-bold text-gray-500">Date</label>
                                    <input type="date" id="receipt-date" class="w-full border p-2 rounded mt-1 bg-gray-50" required>
                                </div>
                                <button type="submit" class="w-full bg-emerald-700 text-white py-2 rounded hover:bg-emerald-800">Generate & Save</button>
                            </form>
                        </div>

                        <!-- History & Validation -->
                        <div class="lg:col-span-2 space-y-6">
                            <div class="bg-white p-6 rounded-xl shadow-sm">
                                <h3 class="font-bold text-lg mb-4 text-gray-700">Validate Receipt</h3>
                                <div class="flex gap-2">
                                    <input type="text" id="validate-receipt-no" placeholder="Enter Receipt No (e.g. RCP-1234)" class="flex-1 border p-2 rounded">
                                    <button onclick="validateReceipt()" class="bg-blue-600 text-white px-4 rounded hover:bg-blue-700">Check</button>
                                </div>
                            </div>
                            
                            <div class="bg-white p-6 rounded-xl shadow-sm">
                                <h3 class="font-bold text-lg mb-4 text-gray-700">Transaction History</h3>
                                <div class="overflow-y-auto max-h-64">
                                    <table class="w-full text-sm text-left min-w-[500px]">
                                        <thead class="bg-gray-50 sticky top-0">
                                            <tr>
                                                <th class="p-2">No.</th>
                                                <th class="p-2">Student</th>
                                                <th class="p-2">Amount</th>
                                                <th class="p-2">Date</th>
                                                <th class="p-2 text-right">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="receipt-history-tbody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 7. TIMETABLE -->
                <div id="view-timetable" class="view-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Class Timetables</h2>
                    <div class="bg-white p-6 rounded-xl shadow-sm mb-6 no-print">
                         <div class="flex gap-4 items-end flex-wrap">
                            <div class="flex-1 min-w-[200px]">
                                <label class="block text-sm font-bold text-gray-600">Select Class</label>
                                <select id="timetable-class" class="w-full border p-2 rounded mt-1"></select>
                            </div>
                            <button onclick="loadTimetable()" class="bg-blue-600 text-white px-6 py-2 rounded">Load</button>
                            <button onclick="printTimetable()" class="bg-gray-800 text-white px-6 py-2 rounded"><i class="fas fa-print"></i> Print</button>
                        </div>
                    </div>
                    
                    <div id="timetable-container" class="bg-white rounded-xl shadow-sm p-4 overflow-x-auto">
                        <div id="timetable-print-wrapper" class="min-w-[800px] md:min-w-0">
                            <!-- Injected Table -->
                        </div>
                        <button onclick="saveTimetable()" class="mt-4 bg-emerald-600 text-white px-6 py-2 rounded no-print">Save Timetable</button>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- DEDICATED GLOBAL PRINT CONTAINER -->
    <!-- This is the ONLY thing that will appear when printing -->
    <div id="global-print-container" class="hidden"></div>

    <!-- ADD STUDENT MODAL -->
    <div id="add-student-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 m-4">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Add New Student</h3>
            <form id="create-student-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Full Name</label>
                    <input type="text" id="new-std-name" class="w-full border p-2 rounded mt-1" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Class</label>
                    <select id="new-std-class" class="w-full border p-2 rounded mt-1"></select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Photo</label>
                    <input type="file" id="new-std-photo" accept="image/*" class="w-full border p-2 rounded mt-1 text-sm">
                    <p class="text-xs text-gray-500 mt-1">Max 100KB. Resize locally if needed.</p>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="closeModal('add-student-modal')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700">Save Student</button>
                </div>
            </form>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, setDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyB3nMQMbc_nlQqcKUEsH-puraiUzrXQLY0",
            authDomain: "nurul-bayan-science-academy.firebaseapp.com",
            projectId: "nurul-bayan-science-academy",
            storageBucket: "nurul-bayan-science-academy.firebasestorage.app",
            messagingSenderId: "86444557578",
            appId: "1:86444557578:web:ec17056fa02214e4b126f3",
            measurementId: "G-NQ2Q9RLLSC"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- GLOBAL VARIABLES ---
        const CLASSES = [
            "Pre-Nursery", "Nursery 1", "Nursery 2", 
            "Primary 1", "Primary 2", "Primary 3", "Primary 4", "Primary 5", "Primary 6",
            "Islamiyya"
        ];
        
        let currentUser = sessionStorage.getItem('user');
        
        // --- AUTHENTICATION ---
        window.login = function(e) {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            
            if(u === 'Edu' && p === 'Edu123') {
                sessionStorage.setItem('user', 'admin');
                currentUser = 'admin';
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                initApp();
            } else {
                showToast('Invalid credentials', 'error');
            }
        };

        window.logout = function() {
            sessionStorage.removeItem('user');
            location.reload();
        };

        document.getElementById('login-form').addEventListener('submit', window.login);

        if(currentUser) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            initApp();
        }

        // --- NAVIGATION ---
        window.nav = function(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-' + viewId).classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-emerald-800', 'border-emerald-400');
                btn.classList.add('border-transparent');
            });
            event.currentTarget.classList.add('bg-emerald-800', 'border-emerald-400');
            event.currentTarget.classList.remove('border-transparent');

            if(window.innerWidth < 768) {
                document.getElementById('sidebar').classList.add('hidden');
            }

            if(viewId === 'dashboard') loadDashboardStats();
            if(viewId === 'finance') loadReceiptHistory();
        };

        document.getElementById('menu-toggle').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('hidden');
        });

        // --- INITIALIZATION ---
        function initApp() {
            populateClassDropdowns();
            loadDashboardStats();
            loadStudents();
            loadSubjectsList();
        }

        function populateClassDropdowns() {
            const ids = ['new-std-class', 'filter-class-student', 'subject-class', 'marks-class', 'report-class', 'receipt-class', 'timetable-class'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if(!el) return;
                const hasAll = el.querySelector('option[value="All"]');
                el.innerHTML = hasAll ? '<option value="All">All Classes</option>' : '';
                
                CLASSES.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c;
                    opt.textContent = c;
                    el.appendChild(opt);
                });
            });
        }

        // --- UTILS ---
        window.showToast = function(msg, type='success') {
            const container = document.getElementById('toast-container');
            const div = document.createElement('div');
            div.className = `p-4 rounded shadow-lg text-white font-medium animate-bounce ${type === 'error' ? 'bg-red-500' : 'bg-emerald-600'}`;
            div.textContent = msg;
            container.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        };

        window.openModal = (id) => document.getElementById(id).classList.add('active');
        window.closeModal = (id) => document.getElementById(id).classList.remove('active');

        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const scale = 300 / img.width;
                        canvas.width = 300;
                        canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7)); 
                    }
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
        };

        // --- STUDENT MANAGEMENT ---
        document.getElementById('create-student-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('new-std-name').value;
            const cls = document.getElementById('new-std-class').value;
            const fileInput = document.getElementById('new-std-photo');
            
            let photo = null;
            if(fileInput.files[0]) {
                photo = await fileToBase64(fileInput.files[0]);
            }

            try {
                await addDoc(collection(db, 'students'), {
                    name, class: cls, photo, createdAt: new Date()
                });
                showToast('Student Added!');
                closeModal('add-student-modal');
                e.target.reset();
                loadStudents();
            } catch(err) {
                console.error(err);
                showToast('Error adding student', 'error');
            }
        });

        window.loadStudents = async () => {
            const filterClass = document.getElementById('filter-class-student').value;
            const tbody = document.getElementById('students-table-body');
            tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4"><div class="loader mx-auto"></div></td></tr>';

            let q = collection(db, 'students');
            if(filterClass !== 'All') {
                q = query(collection(db, 'students'), where('class', '==', filterClass));
            }

            const snap = await getDocs(q);
            tbody.innerHTML = '';

            snap.forEach(docSnap => {
                const s = docSnap.data();
                const row = `
                    <tr class="hover:bg-gray-50 group">
                        <td class="p-4">
                            <div class="h-10 w-10 rounded-full bg-gray-200 overflow-hidden">
                                ${s.photo ? `<img src="${s.photo}" class="h-full w-full object-cover">` : '<i class="fas fa-user text-gray-400 p-2"></i>'}
                            </div>
                        </td>
                        <td class="p-4 font-medium text-gray-800">${s.name}</td>
                        <td class="p-4 text-gray-500">${s.class}</td>
                        <td class="p-4 text-center">
                            <button onclick="deleteStudent('${docSnap.id}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        };

        window.deleteStudent = async (id) => {
            if(confirm('Are you sure? This will delete all marks for this student too.')) {
                await deleteDoc(doc(db, 'students', id));
                loadStudents();
                showToast('Student deleted');
            }
        };

        window.filterStudentsTable = () => {
            const term = document.getElementById('search-student').value.toLowerCase();
            const rows = document.querySelectorAll('#students-table-body tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(term) ? '' : 'none';
            });
        };

        // --- SUBJECTS ---
        document.getElementById('add-subject-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const cls = document.getElementById('subject-class').value;
            const name = document.getElementById('subject-name').value;

            await addDoc(collection(db, 'subjects'), { className: cls, name });
            showToast('Subject Added');
            document.getElementById('subject-name').value = '';
            loadSubjectsList();
        });

        window.loadSubjectsList = async () => {
            const list = document.getElementById('subjects-list');
            const snap = await getDocs(collection(db, 'subjects'));
            list.innerHTML = '';
            snap.forEach(d => {
                const sub = d.data();
                list.insertAdjacentHTML('beforeend', `
                    <li class="flex justify-between p-2 bg-gray-50 rounded border border-gray-100">
                        <span><span class="font-bold text-xs text-emerald-600 mr-2 px-1 border border-emerald-200 rounded">${sub.className}</span> ${sub.name}</span>
                        <button onclick="deleteSubject('${d.id}')" class="text-red-400 text-xs hover:text-red-600"><i class="fas fa-trash"></i></button>
                    </li>
                `);
            });
        };
        
        window.deleteSubject = async (id) => {
            if(confirm('Delete subject?')) {
                await deleteDoc(doc(db, 'subjects', id));
                loadSubjectsList();
            }
        };

        // --- MARKS ---
        window.loadSubjectsForMarks = async () => {
            const cls = document.getElementById('marks-class').value;
            const subSel = document.getElementById('marks-subject');
            subSel.innerHTML = '<option>Loading...</option>';
            
            const q = query(collection(db, 'subjects'), where('className', '==', cls));
            const snap = await getDocs(q);
            subSel.innerHTML = '';
            snap.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.data().name;
                opt.textContent = d.data().name;
                subSel.appendChild(opt);
            });
        };

        window.loadMarksTable = async () => {
            const cls = document.getElementById('marks-class').value;
            const sub = document.getElementById('marks-subject').value;
            if(!sub) return showToast('Select a subject', 'error');

            const tbody = document.getElementById('marks-tbody');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4">Loading...</td></tr>';

            const studentsSnap = await getDocs(query(collection(db, 'students'), where('class', '==', cls)));
            const marksQ = query(collection(db, 'marks'), where('class', '==', cls), where('subject', '==', sub));
            const marksSnap = await getDocs(marksQ);
            const marksMap = {};
            marksSnap.forEach(d => marksMap[d.data().studentId] = { ...d.data(), docId: d.id });

            tbody.innerHTML = '';
            studentsSnap.forEach(s => {
                const std = s.data();
                const m = marksMap[s.id] || { ca1:0, ca2:0, exam:0 };
                const total = (Number(m.ca1)+Number(m.ca2)+Number(m.exam));
                
                tbody.insertAdjacentHTML('beforeend', `
                    <tr data-sid="${s.id}" data-docid="${m.docId || ''}">
                        <td class="p-3 font-medium">${std.name}</td>
                        <td class="p-1"><input type="number" max="20" class="w-full border p-1 rounded mark-input" name="ca1" value="${m.ca1}"></td>
                        <td class="p-1"><input type="number" max="20" class="w-full border p-1 rounded mark-input" name="ca2" value="${m.ca2}"></td>
                        <td class="p-1"><input type="number" max="60" class="w-full border p-1 rounded mark-input" name="exam" value="${m.exam}"></td>
                        <td class="p-3 font-bold text-center total-cell">${total}</td>
                        <td class="p-3 text-center grade-cell">${calculateGrade(total)}</td>
                    </tr>
                `);
            });

            document.getElementById('marks-entry-container').classList.remove('hidden');
            
            document.querySelectorAll('.mark-input').forEach(inp => {
                inp.addEventListener('input', updateRowTotal);
            });
        };

        function updateRowTotal(e) {
            const row = e.target.closest('tr');
            const ca1 = Number(row.querySelector('[name="ca1"]').value) || 0;
            const ca2 = Number(row.querySelector('[name="ca2"]').value) || 0;
            const exam = Number(row.querySelector('[name="exam"]').value) || 0;
            const total = ca1 + ca2 + exam;
            row.querySelector('.total-cell').textContent = total;
            row.querySelector('.grade-cell').textContent = calculateGrade(total);
        }

        function calculateGrade(score) {
            if(score >= 70) return 'A';
            if(score >= 60) return 'B';
            if(score >= 50) return 'C';
            if(score >= 45) return 'D';
            if(score >= 40) return 'E';
            return 'F';
        }

        window.saveMarks = async () => {
            const cls = document.getElementById('marks-class').value;
            const sub = document.getElementById('marks-subject').value;
            const rows = document.querySelectorAll('#marks-tbody tr');
            const batchPromises = [];

            rows.forEach(row => {
                const sid = row.dataset.sid;
                const docId = row.dataset.docid;
                const ca1 = Number(row.querySelector('[name="ca1"]').value);
                const ca2 = Number(row.querySelector('[name="ca2"]').value);
                const exam = Number(row.querySelector('[name="exam"]').value);
                const total = ca1 + ca2 + exam;

                const data = {
                    studentId: sid,
                    class: cls,
                    subject: sub,
                    ca1, ca2, exam, total,
                    session: '2025/2026',
                    term: '1st' 
                };

                if(docId) {
                    batchPromises.push(updateDoc(doc(db, 'marks', docId), data));
                } else {
                    batchPromises.push(addDoc(collection(db, 'marks'), data));
                }
            });

            try {
                await Promise.all(batchPromises);
                showToast('Marks Saved Successfully');
                loadMarksTable(); 
            } catch(err) {
                showToast('Error saving marks', 'error');
            }
        };

        window.deleteMarksForSubject = async () => {
             const cls = document.getElementById('marks-class').value;
             const sub = document.getElementById('marks-subject').value;
             
             if(confirm(`Delete ALL marks for ${sub} in ${cls}?`)) {
                 const q = query(collection(db, 'marks'), where('class', '==', cls), where('subject', '==', sub));
                 const snap = await getDocs(q);
                 const promises = snap.docs.map(d => deleteDoc(d.ref));
                 await Promise.all(promises);
                 showToast('Marks deleted');
                 loadMarksTable();
             }
        };

        // --- REPORT CARDS (Complex Logic) ---
        let currentClassReportData = [];

        window.generateReportList = async () => {
            const cls = document.getElementById('report-class').value;
            const term = document.getElementById('report-term').value;
            
            if(!document.getElementById('next-term-date').value) {
                showToast('Please set Next Term Date', 'error');
                return;
            }

            const tbody = document.getElementById('report-list-tbody');
            tbody.innerHTML = '<tr><td colspan="4">Calculating...</td></tr>';
            document.getElementById('report-list-container').classList.remove('hidden');

            const stdSnap = await getDocs(query(collection(db, 'students'), where('class', '==', cls)));
            const students = [];
            stdSnap.forEach(d => students.push({ ...d.data(), id: d.id }));

            const marksSnap = await getDocs(query(collection(db, 'marks'), where('class', '==', cls)));
            const marks = [];
            marksSnap.forEach(d => marks.push(d.data()));

            const processed = students.map(std => {
                const stdMarks = marks.filter(m => m.studentId === std.id);
                const totalScore = stdMarks.reduce((sum, m) => sum + m.total, 0);
                const avg = stdMarks.length ? (totalScore / stdMarks.length).toFixed(1) : 0;
                
                return {
                    student: std,
                    marks: stdMarks,
                    totalScore,
                    average: parseFloat(avg)
                };
            });

            processed.sort((a, b) => b.average - a.average);
            
            processed.forEach((p, index) => {
                p.position = index + 1;
                p.positionDisplay = getCustomPositionTier(p.average);
            });

            currentClassReportData = processed;

            tbody.innerHTML = '';
            processed.forEach(p => {
                tbody.insertAdjacentHTML('beforeend', `
                    <tr class="border-b">
                        <td class="p-2 font-bold">${p.positionDisplay}</td>
                        <td class="p-2">${p.student.name}</td>
                        <td class="p-2 font-mono">${p.average}</td>
                        <td class="p-2">
                            <button onclick="printReport('${p.student.id}')" class="text-emerald-600 font-bold hover:underline">Print</button>
                        </td>
                    </tr>
                `);
            });
        };
        
        function getCustomPositionTier(avg) {
             const score = parseFloat(avg);
             if (score >= 90) return "1A";
             if (score >= 80) return "1B";
             if (score >= 70) return "2A";
             if (score >= 60) return "2B";
             if (score >= 50) return "3A";
             if (score >= 40) return "3B";
             return "4th";
        }

        // --- BULK PRINTING FUNCTIONALITY ---
        window.printAllReports = async () => {
             if(currentClassReportData.length === 0) return showToast('Generate list first', 'error');
             
             // Use the global print container
             const container = document.getElementById('global-print-container');
             container.innerHTML = ''; 
             container.classList.remove('hidden');

             // Generate HTML for ALL students
             for (const data of currentClassReportData) {
                 const reportHTML = await generateReportHTML(data);
                 const wrapper = document.createElement('div');
                 wrapper.className = 'report-page-wrapper';
                 wrapper.innerHTML = reportHTML;
                 container.appendChild(wrapper);
                 
                 // Generate QR Code
                 const qrDiv = wrapper.querySelector('.qr-code-placeholder');
                 const qrImg = wrapper.querySelector('.qr-code-img');
                 const verifyUrl = `https://nurul-bayan-academy.web.app/verify?id=${data.student.id}`;
                 
                 new QRCode(qrDiv, { text: verifyUrl, width: 80, height: 80 });
                 
                 // Wait for canvas
                 await new Promise(r => setTimeout(r, 50)); 
                 const canvas = qrDiv.querySelector('canvas');
                 if(canvas) {
                     qrImg.src = canvas.toDataURL();
                     qrDiv.style.display = 'none';
                 }
             }

             window.print();
             
             // Cleanup after print
             setTimeout(() => {
                 container.classList.add('hidden');
                 container.innerHTML = ''; 
             }, 1000);
        };

        window.printReport = async (studentId) => {
            const data = currentClassReportData.find(d => d.student.id === studentId);
            if(!data) return;
            
            const container = document.getElementById('global-print-container');
            container.innerHTML = '';
            
            const reportHTML = await generateReportHTML(data);
            const wrapper = document.createElement('div');
            wrapper.className = 'report-page-wrapper';
            wrapper.innerHTML = reportHTML;
            container.appendChild(wrapper);
            container.classList.remove('hidden');

            const qrDiv = wrapper.querySelector('.qr-code-placeholder');
            const qrImg = wrapper.querySelector('.qr-code-img');
            const verifyUrl = `https://nurul-bayan-academy.web.app/verify?id=${data.student.id}`;
            
            new QRCode(qrDiv, { text: verifyUrl, width: 80, height: 80 });
            
            setTimeout(() => {
                const canvas = qrDiv.querySelector('canvas');
                if(canvas) {
                    qrImg.src = canvas.toDataURL();
                    qrDiv.style.display = 'none';
                }
                window.print();
                 setTimeout(() => {
                     container.classList.add('hidden');
                     container.innerHTML = '';
                 }, 1000);
            }, 300);
        };

        async function generateReportHTML(data) {
            const nextTerm = document.getElementById('next-term-date').value;
            const term = document.getElementById('report-term').value;
            const session = '2025 / 2026';

            let comment = "";
            if(data.average >= 80) comment = "An excellent result. Keep it up!";
            else if(data.average >= 60) comment = "A good performance, but there is room for improvement.";
            else comment = "More effort is required next term.";

            let subjectsRows = data.marks.map(m => `
                <tr>
                    <td class="p-1 pl-2 border border-emerald-900">${m.subject}</td>
                    <td class="p-1 text-center border border-emerald-900">${m.ca1}</td>
                    <td class="p-1 text-center border border-emerald-900">${m.ca2}</td>
                    <td class="p-1 text-center border border-emerald-900">${m.exam}</td>
                    <td class="p-1 text-center border border-emerald-900 font-bold">${m.total}</td>
                    <td class="p-1 text-center border border-emerald-900 font-bold ${getGradeColor(calculateGrade(m.total))}">${calculateGrade(m.total)}</td>
                </tr>
            `).join('');

            return `
                <div class="h-full w-full border-4 border-emerald-800 p-1 bg-white relative text-gray-800 flex flex-col">
                    <div class="h-full border-2 border-amber-500 p-4 relative flex flex-col flex-grow">
                        
                        <!-- Watermark -->
                        <div class="absolute inset-0 flex items-center justify-center opacity-5 pointer-events-none">
                            <i class="fas fa-book-quran text-[400px]"></i>
                        </div>

                        <!-- Header -->
                        <div class="flex justify-between items-center border-b-2 border-emerald-800 pb-2 mb-2 flex-shrink-0">
                            <div class="w-24 text-center">
                                <div class="text-4xl text-emerald-800"><i class="fas fa-book-open"></i></div>
                            </div>
                            <div class="text-center flex-1">
                                <h2 class="text-2xl arabic-text text-emerald-700 font-bold mb-1">نور البيان الأكاديمية للعلوم</h2>
                                <h1 class="text-2xl font-bold text-emerald-800 uppercase font-serif tracking-wide leading-tight">Nurul Bayan Science Academy</h1>
                                <p class="text-xs font-bold mt-1">No. 2222 Janbulo Housing Estate, Opposite Afforestation, Dorayi Babba, Gwale LGA, Kano</p>
                                <p class="text-[10px] mt-0.5">Tel: +234-8119723517, +234-8189231849 | Email: nurulbayanscienceacademy18@gmail.com</p>
                                <div class="bg-emerald-800 text-amber-400 text-xs font-bold px-4 py-0.5 mt-1 inline-block rounded-full uppercase tracking-wider">Motto: Knowledge is the Root of Success</div>
                            </div>
                            <div class="w-24 h-24 border border-gray-300 bg-gray-100 flex items-center justify-center overflow-hidden">
                                ${data.student.photo ? `<img src="${data.student.photo}" class="w-full h-full object-cover">` : '<span class="text-xs text-gray-400">Photo</span>'}
                            </div>
                        </div>

                        <!-- Student Info Grid -->
                        <div class="bg-emerald-50 border border-emerald-200 p-2 mb-2 flex-shrink-0">
                            <div class="grid grid-cols-3 gap-2 text-sm">
                                <div><span class="font-bold text-emerald-800">Name:</span> <span class="uppercase">${data.student.name}</span></div>
                                <div><span class="font-bold text-emerald-800">Class:</span> ${data.student.class}</div>
                                <div><span class="font-bold text-emerald-800">Session:</span> ${session}</div>
                                <div><span class="font-bold text-emerald-800">Term:</span> ${term}</div>
                                <div><span class="font-bold text-emerald-800">No. in Class:</span> ${currentClassReportData.length}</div>
                                <div><span class="font-bold text-emerald-800">Position:</span> <span class="text-red-600 font-bold border border-red-600 px-1 rounded bg-white">${data.positionDisplay}</span></div>
                            </div>
                        </div>

                        <!-- Marks Table -->
                        <div class="flex-grow flex flex-col mb-2">
                            <table class="w-full text-sm border-collapse">
                                <thead>
                                    <tr class="bg-emerald-800 text-white">
                                        <th class="p-1 border border-emerald-900 text-left pl-2">Subject</th>
                                        <th class="p-1 border border-emerald-900 w-12">CA1</th>
                                        <th class="p-1 border border-emerald-900 w-12">CA2</th>
                                        <th class="p-1 border border-emerald-900 w-12">Exam</th>
                                        <th class="p-1 border border-emerald-900 w-12">Total</th>
                                        <th class="p-1 border border-emerald-900 w-12">Grade</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${subjectsRows}
                                </tbody>
                            </table>
                        </div>

                        <!-- Summary -->
                        <div class="flex gap-4 mb-2 flex-shrink-0">
                            <div class="w-2/3 border border-emerald-800 p-2">
                                <div class="flex justify-between mb-2 border-b border-gray-200 pb-1">
                                    <span class="font-bold text-sm">Total Score: ${data.totalScore}</span>
                                    <span class="font-bold text-sm">Average: ${data.average}</span>
                                    <span class="font-bold text-sm text-blue-600">Decision: ${data.average > 40 ? 'Promoted' : 'Check Advice'}</span>
                                </div>
                                <div class="text-sm">
                                    <span class="font-bold text-emerald-800">Principal's Remark:</span>
                                    <p class="italic font-serif text-gray-700">"${comment}"</p>
                                </div>
                            </div>
                            <div class="w-1/3 border border-emerald-800 p-2 text-xs">
                                <div class="font-bold mb-1">Grading Scale:</div>
                                <div class="grid grid-cols-2 gap-x-2">
                                    <span>70-100: A</span>
                                    <span>60-69: B</span>
                                    <span>50-59: C</span>
                                    <span>45-49: D</span>
                                    <span>40-44: E</span>
                                    <span>0-39: F</span>
                                </div>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div class="flex-shrink-0">
                            <div class="flex justify-between items-end mb-2">
                                <div class="text-center w-1/3">
                                    <div class="text-sm font-bold">Next Term Begins:</div>
                                    <div class="border-b border-black w-full mx-auto mb-1 text-sm">${nextTerm}</div>
                                </div>
                                <div class="relative w-1/3 flex justify-center">
                                    <div class="unique-stamp absolute -top-16">
                                        <div class="unique-stamp-inner">
                                            <i class="fas fa-star text-xs text-secondary"></i>
                                            NURUL BAYAN<br>SCIENCE ACADEMY
                                            <span class="approved">APPROVED</span>
                                            OFFICIAL
                                            <i class="fas fa-star text-xs text-secondary"></i>
                                        </div>
                                    </div>
                                    <div class="text-center mt-6 w-full">
                                        <div class="border-b border-black w-3/4 mx-auto mb-1"></div>
                                        <div class="text-xs font-bold">Principal's Signature</div>
                                    </div>
                                </div>
                                <div class="w-1/3 flex justify-end">
                                    <div class="qr-code-placeholder mb-1"></div>
                                    <img class="qr-code-img w-20 h-20" />
                                </div>
                            </div>
                            
                            <div class="bg-emerald-800 text-white text-[10px] text-center p-1 rounded-sm">
                                <p class="font-bold">NOTICE TO PARENTS: Keep this report card safe. It is required for next term registration.</p>
                                <p class="opacity-75 mt-0.5">Developed by Abu-Abdurrahman CodeVerge Technology | +2348107907647</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getGradeColor(g) {
            if(g==='A') return 'text-green-600';
            if(g==='B') return 'text-blue-600';
            if(g==='F') return 'text-red-600';
            return 'text-gray-800';
        }
        
        window.exportExcel = () => {
             const ws = XLSX.utils.json_to_sheet(currentClassReportData.map(d => ({
                 Name: d.student.name,
                 Average: d.average,
                 Position: d.positionDisplay
             })));
             const wb = XLSX.utils.book_new();
             XLSX.utils.book_append_sheet(wb, ws, "Report");
             XLSX.writeFile(wb, "ClassReport.xlsx");
        };

        // --- RECEIPT SYSTEM ---
        window.updateReceiptStudents = async () => {
            const cls = document.getElementById('receipt-class').value;
            const sel = document.getElementById('receipt-student');
            sel.innerHTML = '<option>Loading...</option>';
            
            const q = query(collection(db, 'students'), where('class', '==', cls));
            const snap = await getDocs(q);
            sel.innerHTML = '';
            snap.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.data().name;
                opt.textContent = d.data().name;
                sel.appendChild(opt);
            });
        };

        document.getElementById('receipt-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const std = document.getElementById('receipt-student').value;
            const amt = document.getElementById('receipt-amount').value;
            const pur = document.getElementById('receipt-purpose').value;
            const date = document.getElementById('receipt-date').value;
            const cls = document.getElementById('receipt-class').value;
            const rNo = 'NB-' + Math.floor(1000 + Math.random() * 9000);

            const data = {
                receiptNo: rNo,
                student: std,
                class: cls,
                amount: amt,
                purpose: pur,
                date: date,
                timestamp: new Date()
            };

            await addDoc(collection(db, 'receipts'), data);
            showToast('Receipt Generated!');
            printReceipt(data);
            e.target.reset();
            loadReceiptHistory();
        });

        window.loadReceiptHistory = async () => {
            const tbody = document.getElementById('receipt-history-tbody');
            const snap = await getDocs(query(collection(db, 'receipts')));
            tbody.innerHTML = '';
            snap.forEach(d => {
                const r = d.data();
                tbody.insertAdjacentHTML('beforeend', `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-2 font-mono text-xs">${r.receiptNo}</td>
                        <td class="p-2">${r.student}</td>
                        <td class="p-2 font-bold">₦${r.amount}</td>
                        <td class="p-2 text-xs">${r.date}</td>
                        <td class="p-2 text-right">
                            <button onclick='reprintReceipt(${JSON.stringify(r)})' class="text-blue-600 mr-2"><i class="fas fa-print"></i></button>
                            <button onclick="deleteReceipt('${d.id}')" class="text-red-500"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `);
            });
            document.getElementById('dash-total-receipts').textContent = snap.size;
        };
        
        window.deleteReceipt = async(id) => {
            if(confirm('Delete this record?')) {
                await deleteDoc(doc(db, 'receipts', id));
                loadReceiptHistory();
            }
        };

        window.reprintReceipt = (data) => printReceipt(data);

        function printReceipt(r) {
            const area = document.getElementById('global-print-container');
            area.innerHTML = `
                 <div class="border-2 border-dashed border-gray-400 p-6 max-w-xl mx-auto relative bg-white mt-8">
                    <div class="flex items-center gap-4 mb-4 border-b pb-4">
                         <div class="text-4xl text-emerald-800"><i class="fas fa-university"></i></div>
                         <div>
                            <h2 class="font-bold text-xl text-emerald-800">NURUL BAYAN SCIENCE ACADEMY</h2>
                            <p class="text-xs text-gray-600">No. 2222 Janbulo Housing Estate, Kano</p>
                            <p class="text-xs text-gray-600">Tel: +234-8119723517</p>
                         </div>
                    </div>
                    
                    <div class="flex justify-between items-center mb-6">
                        <div class="bg-gray-100 px-3 py-1 rounded">
                            <span class="text-xs text-gray-500 uppercase">Receipt No</span>
                            <div class="font-mono font-bold text-lg">${r.receiptNo}</div>
                        </div>
                        <div class="text-right">
                            <span class="text-xs text-gray-500 uppercase">Date</span>
                            <div class="font-bold">${r.date}</div>
                        </div>
                    </div>

                    <div class="space-y-3 text-sm mb-8">
                        <div class="flex justify-between border-b border-dotted py-1">
                            <span class="text-gray-500">Received From:</span>
                            <span class="font-bold uppercase">${r.student}</span>
                        </div>
                        <div class="flex justify-between border-b border-dotted py-1">
                            <span class="text-gray-500">Class:</span>
                            <span class="font-bold">${r.class}</span>
                        </div>
                        <div class="flex justify-between border-b border-dotted py-1">
                            <span class="text-gray-500">Payment For:</span>
                            <span class="font-bold">${r.purpose}</span>
                        </div>
                         <div class="flex justify-between border-b border-dotted py-1">
                            <span class="text-gray-500">Amount:</span>
                            <span class="font-bold text-xl text-emerald-800">₦${r.amount}</span>
                        </div>
                    </div>

                    <div class="flex justify-between items-end">
                        <div class="text-[10px] text-gray-400">
                             Generated by Admin<br>
                             ${new Date().toLocaleString()}
                        </div>
                         <div class="unique-stamp" style="width: 80px; height: 80px; font-size: 8px;">
                            <div class="unique-stamp-inner">PAID</div>
                        </div>
                    </div>
                    
                    <div class="mt-4 text-center text-[10px] text-gray-500 pt-2 border-t">
                        Dev: Abu-Abdurrahman CodeVerge | +2348107907647
                    </div>
                </div>
            `;
            area.classList.remove('hidden');
            setTimeout(() => {
                window.print();
                setTimeout(() => {
                     area.classList.add('hidden');
                     area.innerHTML = '';
                }, 1000);
            }, 300);
        }

        // --- TIMETABLE ---
        const periods = ['8:00-8:40', '8:40-9:20', '9:20-10:00', 'Break', '10:30-11:10', '11:10-11:50', '11:50-12:30'];
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];

        window.loadTimetable = async () => {
            const cls = document.getElementById('timetable-class').value;
            const wrapper = document.getElementById('timetable-print-wrapper');
            
            const q = query(collection(db, 'timetable'), where('class', '==', cls));
            const snap = await getDocs(q);
            let savedData = {};
            if(!snap.empty) {
                savedData = JSON.parse(snap.docs[0].data().json);
                wrapper.dataset.docId = snap.docs[0].id;
            } else {
                wrapper.dataset.docId = '';
            }

            let html = `
                <div class="print-container">
                    <div class="text-center mb-6">
                         <div class="flex justify-between items-center border-b-2 border-emerald-800 pb-2 mb-2">
                             <div class="text-4xl text-emerald-800"><i class="fas fa-book-open"></i></div>
                             <div class="text-center">
                                <h1 class="text-2xl font-bold uppercase text-emerald-800">Nurul Bayan Science Academy</h1>
                                <div class="bg-amber-500 text-white px-4 py-1 inline-block rounded-full font-bold mt-1 shadow-sm">CLASS TIMETABLE: ${cls}</div>
                             </div>
                             <div class="text-4xl text-emerald-800"><i class="fas fa-graduation-cap"></i></div>
                         </div>
                    </div>
                    <table class="w-full border-2 border-emerald-800 text-sm text-center shadow-lg rounded-lg overflow-hidden">
                        <thead>
                            <tr class="tt-header">
                                <th class="p-3 border border-white/20">Day/Time</th>
                                ${periods.map(p => `<th class="p-3 border border-white/20">${p}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
            `;

            days.forEach((day, index) => {
                const bgRow = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                html += `<tr class="${bgRow}"><td class="border border-emerald-200 font-bold bg-emerald-100 text-emerald-900 p-2">${day}</td>`;
                periods.forEach((p, idx) => {
                    const key = `${day}-${idx}`;
                    const val = savedData[key] || '';
                    if(p === 'Break') {
                        html += `<td class="border border-emerald-200 bg-amber-100 font-bold text-amber-800 text-xs tracking-widest relative">
                                    <div class="absolute inset-0 flex items-center justify-center -rotate-45 opacity-50">BREAK</div>
                                 </td>`;
                    } else {
                        html += `<td class="border border-emerald-200 p-0 tt-cell"><input type="text" class="tt-input w-full h-full text-center p-2 outline-none bg-transparent font-medium text-gray-700 placeholder-gray-300" data-key="${key}" value="${val}" placeholder="..."></td>`;
                    }
                });
                html += `</tr>`;
            });
            
            html += `</tbody></table>
                <div class="mt-4 text-center text-xs text-gray-500 font-bold uppercase">Effective from: 2025/2026 Session</div>
            </div>`;
            wrapper.innerHTML = html;
        };

        window.saveTimetable = async () => {
            const cls = document.getElementById('timetable-class').value;
            const inputs = document.querySelectorAll('.tt-input');
            const data = {};
            inputs.forEach(inp => data[inp.dataset.key] = inp.value);
            
            const wrapper = document.getElementById('timetable-print-wrapper');
            const docId = wrapper.dataset.docId;

            if(docId) {
                await updateDoc(doc(db, 'timetable', docId), { json: JSON.stringify(data) });
            } else {
                await addDoc(collection(db, 'timetable'), { class: cls, json: JSON.stringify(data) });
            }
            showToast('Timetable Saved');
        };

        window.printTimetable = () => {
            const inputs = document.querySelectorAll('.tt-input');
            inputs.forEach(i => {
                i.parentElement.innerHTML = `<div class="p-2 font-bold text-gray-800 text-center">${i.value}</div>`;
            });
            
            const wrapper = document.getElementById('timetable-print-wrapper');
            const printArea = document.getElementById('global-print-container');
            printArea.innerHTML = wrapper.innerHTML;
            printArea.classList.remove('hidden');
            
            window.print();
            
            setTimeout(() => {
                printArea.classList.add('hidden');
                printArea.innerHTML = '';
                loadTimetable();
            }, 1000);
        };

        // --- DASHBOARD STATS ---
        window.loadDashboardStats = async () => {
            const sSnap = await getDocs(collection(db, 'students'));
            document.getElementById('dash-total-students').textContent = sSnap.size;
        };

    </script>
</body>
</html>
