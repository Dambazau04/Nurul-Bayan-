<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nurul Bayan Science Academy - Portal</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- SheetJS for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #047857; /* Deep Green */
            --secondary: #D4AF37; /* Gold */
            --dark: #1F2937;
            --light: #F3F4F6;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f2f5;
            overflow-x: hidden;
        }

        .arabic-text {
            font-family: 'Amiri', serif;
        }

        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        .slide-up { animation: slideUp 0.5s ease-out; }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 4px; }

        /* PRINT STYLES - CRITICAL */
        @media print {
            @page { size: auto; margin: 0mm; }
            body * { visibility: hidden; }
            
            /* Print Area Visibility */
            #print-area, #print-area * {
                visibility: visible;
            }
            
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                background: white;
            }

            /* Report Card Specifics */
            .report-card-page {
                width: 210mm;
                height: 297mm;
                padding: 10mm;
                page-break-after: always;
                position: relative;
                border: none !important;
                box-shadow: none !important;
            }

            /* Receipt Specifics */
            .receipt-page {
                width: 100%;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
            }

            /* Timetable Specifics (Landscape) */
            .timetable-page {
                width: 297mm;
                height: 210mm;
                transform: rotate(0deg); /* Browser usually handles orientation via @page */
            }

            @page {
                size: A4 portrait; /* Default */
            }

            /* Background Colors Logic */
            .bg-green-700 { background-color: #047857 !important; -webkit-print-color-adjust: exact; }
            .text-white { color: white !important; -webkit-print-color-adjust: exact; }
            .bg-gray-100 { background-color: #f3f4f6 !important; -webkit-print-color-adjust: exact; }
            
            .no-print-break { break-inside: avoid; }
        }

        /* Stamp Style */
        .school-stamp {
            border: 3px double var(--primary);
            border-radius: 50%;
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: var(--primary);
            font-weight: bold;
            font-size: 10px;
            transform: rotate(-15deg);
            opacity: 0.8;
            mask-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='); /* Simple noise mask */
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-green-800 to-green-600">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-96 text-center slide-up">
            <div class="mb-6">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-graduation-cap text-3xl text-green-700"></i>
                </div>
                <h2 class="text-2xl font-bold text-green-800">Admin Login</h2>
                <p class="text-gray-500 text-sm">Nurul Bayan Science Academy</p>
            </div>
            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="mb-4">
                    <input type="text" id="username" placeholder="Username" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500 transition" required>
                </div>
                <div class="mb-6">
                    <input type="password" id="password" placeholder="Password" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500 transition" required>
                </div>
                <button type="submit" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 rounded-lg transition transform hover:scale-105 shadow-lg">
                    Login securely
                </button>
            </form>
            <p id="login-error" class="text-red-500 text-sm mt-4 hidden">Invalid credentials.</p>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-container" class="hidden min-h-screen flex">
        
        <!-- SIDEBAR -->
        <aside class="w-64 bg-green-900 text-white flex-shrink-0 hidden md:flex flex-col transition-all duration-300" id="sidebar">
            <div class="p-6 text-center border-b border-green-800">
                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-3 text-green-800 font-bold text-2xl">NB</div>
                <h1 class="font-bold text-lg leading-tight">NURUL BAYAN</h1>
                <p class="text-xs text-green-300 opacity-75">Science Academy</p>
            </div>
            
            <nav class="flex-1 overflow-y-auto py-4">
                <ul class="space-y-1">
                    <li><button onclick="navigate('dashboard')" class="nav-btn w-full text-left px-6 py-3 hover:bg-green-800 flex items-center gap-3 transition"><i class="fas fa-home w-5"></i> Dashboard</button></li>
                    <li><button onclick="navigate('students')" class="nav-btn w-full text-left px-6 py-3 hover:bg-green-800 flex items-center gap-3 transition"><i class="fas fa-user-graduate w-5"></i> Students</button></li>
                    <li><button onclick="navigate('subjects')" class="nav-btn w-full text-left px-6 py-3 hover:bg-green-800 flex items-center gap-3 transition"><i class="fas fa-book w-5"></i> Subjects</button></li>
                    <li><button onclick="navigate('scores')" class="nav-btn w-full text-left px-6 py-3 hover:bg-green-800 flex items-center gap-3 transition"><i class="fas fa-edit w-5"></i> Manage Scores</button></li>
                    <li><button onclick="navigate('report-cards')" class="nav-btn w-full text-left px-6 py-3 hover:bg-green-800 flex items-center gap-3 transition"><i class="fas fa-file-invoice w-5"></i> Report Cards</button></li>
                    <li><button onclick="navigate('finance')" class="nav-btn w-full text-left px-6 py-3 hover:bg-green-800 flex items-center gap-3 transition"><i class="fas fa-money-bill-wave w-5"></i> Receipts</button></li>
                    <li><button onclick="navigate('timetable')" class="nav-btn w-full text-left px-6 py-3 hover:bg-green-800 flex items-center gap-3 transition"><i class="fas fa-calendar-alt w-5"></i> Timetable</button></li>
                </ul>
            </nav>

            <div class="p-4 border-t border-green-800">
                <button onclick="logout()" class="w-full bg-red-600 hover:bg-red-700 py-2 rounded text-sm text-white transition">Logout</button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col h-screen overflow-hidden">
            <!-- Header -->
            <header class="bg-white shadow-sm h-16 flex items-center justify-between px-6 z-10">
                <button class="md:hidden text-green-800 text-2xl" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
                <div class="font-bold text-gray-700">Session: <span class="text-green-600">2025/2026</span></div>
                <div class="flex items-center gap-3">
                    <span class="text-sm font-medium text-gray-600">Admin</span>
                    <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-700"><i class="fas fa-user"></i></div>
                </div>
            </header>

            <!-- Content Area -->
            <div id="content-area" class="flex-1 overflow-auto p-4 md:p-8 relative">
                
                <!-- DASHBOARD -->
                <div id="view-dashboard" class="view-section fade-in">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800 border-l-4 border-green-600 pl-3">Dashboard Overview</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl shadow-sm border-b-4 border-green-500">
                            <div class="text-gray-500 text-sm mb-1">Total Students</div>
                            <div class="text-3xl font-bold text-gray-800" id="dash-total-students">0</div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border-b-4 border-blue-500">
                            <div class="text-gray-500 text-sm mb-1">Classes</div>
                            <div class="text-3xl font-bold text-gray-800">10</div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border-b-4 border-yellow-500">
                            <div class="text-gray-500 text-sm mb-1">Receipts Issued</div>
                            <div class="text-3xl font-bold text-gray-800" id="dash-total-receipts">0</div>
                        </div>
                    </div>
                    <div class="bg-green-50 p-6 rounded-xl border border-green-100">
                        <h3 class="font-bold text-green-800 mb-2">Welcome Back!</h3>
                        <p class="text-green-700">Use the sidebar to manage students, record scores, and generate the new A4 Report Cards.</p>
                    </div>
                </div>

                <!-- STUDENTS -->
                <div id="view-students" class="view-section hidden fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 border-l-4 border-green-600 pl-3">Student Management</h2>
                        <button onclick="openModal('student-modal')" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition shadow"><i class="fas fa-plus mr-2"></i> Add Student</button>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div class="p-4 border-b flex gap-4">
                            <select id="filter-class" onchange="renderStudents()" class="border rounded px-3 py-2 text-sm">
                                <option value="all">All Classes</option>
                            </select>
                            <input type="text" id="search-student" onkeyup="renderStudents()" placeholder="Search name..." class="border rounded px-3 py-2 text-sm w-full max-w-xs">
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-gray-50 text-gray-600 text-sm uppercase">
                                    <tr>
                                        <th class="p-4 border-b">Photo</th>
                                        <th class="p-4 border-b">Name</th>
                                        <th class="p-4 border-b">Class</th>
                                        <th class="p-4 border-b text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="student-table-body" class="text-sm text-gray-700">
                                    <!-- Rows populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- SUBJECTS -->
                <div id="view-subjects" class="view-section hidden fade-in">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800 border-l-4 border-green-600 pl-3">Subject Management</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="bg-white p-6 rounded-xl shadow-sm">
                            <h3 class="font-bold mb-4">Add Subject</h3>
                            <form onsubmit="handleAddSubject(event)" class="space-y-4">
                                <select id="subject-class" class="w-full border rounded p-2" required></select>
                                <input type="text" id="subject-name" placeholder="Subject Name (e.g., Mathematics)" class="w-full border rounded p-2" required>
                                <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">Add Subject</button>
                            </form>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm">
                            <h3 class="font-bold mb-4">Existing Subjects</h3>
                            <select id="filter-subject-class" onchange="renderSubjects()" class="w-full border rounded p-2 mb-4"></select>
                            <ul id="subject-list" class="space-y-2">
                                <!-- List populated by JS -->
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- SCORES -->
                <div id="view-scores" class="view-section hidden fade-in">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800 border-l-4 border-green-600 pl-3">Record Scores</h2>
                    <div class="bg-white p-6 rounded-xl shadow-sm mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <select id="score-class" class="border rounded p-2" onchange="loadScoreEntry()"></select>
                            <select id="score-subject" class="border rounded p-2" onchange="loadScoreEntry()"></select>
                            <button onclick="saveAllScores()" class="bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Save All Changes</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-3 border">Student</th>
                                        <th class="p-3 border w-24">CA 1 (20)</th>
                                        <th class="p-3 border w-24">CA 2 (20)</th>
                                        <th class="p-3 border w-24">Exam (60)</th>
                                        <th class="p-3 border w-20 bg-gray-50">Total</th>
                                        <th class="p-3 border w-20 bg-gray-50">Grade</th>
                                    </tr>
                                </thead>
                                <tbody id="score-table-body">
                                    <!-- Score inputs -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- REPORT CARDS -->
                <div id="view-report-cards" class="view-section hidden fade-in">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800 border-l-4 border-green-600 pl-3">Generate Report Cards</h2>
                    <div class="bg-white p-6 rounded-xl shadow-sm mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <select id="report-class" class="border rounded p-2"></select>
                            <div class="flex flex-col">
                                <label class="text-xs text-gray-500">Next Term Begins</label>
                                <input type="date" id="next-term-date" class="border rounded p-2">
                            </div>
                             <div class="flex flex-col">
                                <label class="text-xs text-gray-500">Term</label>
                                <select id="report-term" class="border rounded p-2">
                                    <option value="1st Term">1st Term</option>
                                    <option value="2nd Term">2nd Term</option>
                                    <option value="3rd Term">3rd Term</option>
                                </select>
                            </div>
                            <button onclick="generateReportCards()" class="bg-green-600 text-white p-2 rounded hover:bg-green-700">Generate & Preview</button>
                        </div>
                        <div class="flex gap-4">
                            <button onclick="exportExcel()" class="bg-green-700 text-white px-4 py-2 rounded flex items-center gap-2"><i class="fas fa-file-excel"></i> Export Excel</button>
                        </div>
                        <div id="report-list" class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- List of students to print individually -->
                        </div>
                    </div>
                </div>

                <!-- FINANCE/RECEIPTS -->
                <div id="view-finance" class="view-section hidden fade-in">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800 border-l-4 border-green-600 pl-3">Receipt Management</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Create Receipt -->
                        <div class="bg-white p-6 rounded-xl shadow-sm">
                            <h3 class="font-bold mb-4">New Receipt</h3>
                            <form onsubmit="generateReceipt(event)" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium">Student Name</label>
                                    <input type="text" id="receipt-name" class="w-full border rounded p-2" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium">Class</label>
                                    <select id="receipt-class" class="w-full border rounded p-2" required></select>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium">Amount (â‚¦)</label>
                                        <input type="number" id="receipt-amount" class="w-full border rounded p-2" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium">Date</label>
                                        <input type="date" id="receipt-date" class="w-full border rounded p-2" required>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium">Payment For</label>
                                    <input type="text" id="receipt-purpose" placeholder="e.g., School Fees, Uniform" class="w-full border rounded p-2" required>
                                </div>
                                <button type="submit" class="w-full bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700">Generate & Print</button>
                            </form>
                        </div>

                        <!-- History -->
                        <div class="bg-white p-6 rounded-xl shadow-sm">
                            <h3 class="font-bold mb-4">Recent Transactions</h3>
                            <div class="overflow-y-auto max-h-96">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="p-2 text-left">No.</th>
                                            <th class="p-2 text-left">Student</th>
                                            <th class="p-2 text-left">Amount</th>
                                            <th class="p-2 text-right">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="receipt-history"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TIMETABLE -->
                <div id="view-timetable" class="view-section hidden fade-in">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800 border-l-4 border-green-600 pl-3">Timetable Generator</h2>
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <div class="flex gap-4 mb-6">
                            <select id="timetable-class" class="border rounded p-2 w-64"></select>
                            <button onclick="renderTimetableEditor()" class="bg-blue-600 text-white px-4 py-2 rounded">Load</button>
                            <button onclick="printTimetable()" class="bg-gray-800 text-white px-4 py-2 rounded"><i class="fas fa-print"></i> Print A4 Landscape</button>
                        </div>
                        
                        <div class="overflow-x-auto border rounded-lg">
                            <table id="timetable-editor" class="w-full text-center border-collapse text-sm">
                                <thead>
                                    <tr class="bg-green-800 text-white">
                                        <th class="p-2 border border-green-600">Day/Period</th>
                                        <th class="p-2 border border-green-600">1<br>8:00-8:40</th>
                                        <th class="p-2 border border-green-600">2<br>8:40-9:20</th>
                                        <th class="p-2 border border-green-600">3<br>9:20-10:00</th>
                                        <th class="p-2 border border-green-600 bg-red-800">BREAK<br>10:00-10:30</th>
                                        <th class="p-2 border border-green-600">4<br>10:30-11:10</th>
                                        <th class="p-2 border border-green-600">5<br>11:10-11:50</th>
                                        <th class="p-2 border border-green-600">6<br>11:50-12:30</th>
                                    </tr>
                                </thead>
                                <tbody id="timetable-body">
                                    <!-- Generated rows -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- MODALS -->
    <!-- Add Student Modal -->
    <div id="student-modal" class="fixed inset-0 z-40 hidden flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 slide-up">
            <h3 class="text-xl font-bold mb-4">Add/Edit Student</h3>
            <form id="student-form" onsubmit="handleStudentSave(event)">
                <input type="hidden" id="student-id">
                <div class="mb-4 text-center">
                    <div class="w-24 h-24 mx-auto bg-gray-200 rounded-full overflow-hidden mb-2 border-2 border-green-500">
                        <img id="preview-photo" src="" class="w-full h-full object-cover hidden">
                        <i id="default-icon" class="fas fa-camera text-gray-400 text-3xl mt-8"></i>
                    </div>
                    <label class="cursor-pointer text-blue-600 text-sm hover:underline">
                        Upload Photo
                        <input type="file" id="student-photo" accept="image/*" class="hidden" onchange="previewImage(this)">
                    </label>
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium">Full Name</label>
                    <input type="text" id="student-name" class="w-full border rounded p-2" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium">Class</label>
                    <select id="student-class-select" class="w-full border rounded p-2" required></select>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeModal('student-modal')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Save Student</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Hidden Print Area -->
    <div id="print-area"></div>

    <!-- FIREBASE & APP LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyB3nMQMbc_nlQqcKUEsH-puraiUzrXQLY0",
            authDomain: "nurul-bayan-science-academy.firebaseapp.com",
            projectId: "nurul-bayan-science-academy",
            storageBucket: "nurul-bayan-science-academy.firebasestorage.app",
            messagingSenderId: "86444557578",
            appId: "1:86444557578:web:ec17056fa02214e4b126f3",
            measurementId: "G-NQ2Q9RLLSC"
        };

        // CONSTANTS
        const CLASSES = [
            "Pre-Nursery", 
            "Nursery 1", "Nursery 2", 
            "Primary 1", "Primary 2", "Primary 3", "Primary 4", "Primary 5", "Primary 6",
            "Islamiyya"
        ];
        
        const GRADING_SCALE = [
            { min: 90, max: 100, grade: "1A", remark: "Distinction" },
            { min: 85, max: 89, grade: "1B", remark: "Excellent" },
            { min: 80, max: 84, grade: "2A", remark: "Very Good" },
            { min: 75, max: 79, grade: "2B", remark: "Good" },
            { min: 70, max: 74, grade: "3A", remark: "Credit" },
            { min: 65, max: 69, grade: "3B", remark: "Pass" },
            { min: 60, max: 64, grade: "4A", remark: "Fair" },
            { min: 50, max: 59, grade: "4B", remark: "Weak" },
            { min: 0, max: 49, grade: "F", remark: "Fail" }
        ];

        // STATE
        let db;
        let useLocalStorage = false;
        let appData = {
            students: [],
            subjects: [],
            scores: [],
            receipts: [],
            timetable: {}
        };

        // INIT
        async function initApp() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                // Simple connectivity check
                await getDocs(collection(db, 'test_connection'));
                console.log("Firebase Connected");
            } catch (error) {
                console.warn("Firebase connection failed or permissions denied. Falling back to LocalStorage.", error);
                useLocalStorage = true;
                loadFromLocalStorage();
            }

            setupUI();
            checkAuth();
            
            // Auto-refresh data
            if(sessionStorage.getItem('nb_auth')) {
                fetchData();
            }
        }

        // --- LOCAL STORAGE FALLBACKS ---
        function loadFromLocalStorage() {
            const saved = localStorage.getItem('nb_data');
            if (saved) appData = JSON.parse(saved);
        }

        function saveToLocalStorage() {
            localStorage.setItem('nb_data', JSON.stringify(appData));
        }

        // --- DATA OPERATIONS (Unified Interface) ---
        async function apiAdd(collectionName, data) {
            data.id = Date.now().toString(); // Simple ID for both
            if (useLocalStorage) {
                appData[collectionName] = appData[collectionName] || [];
                appData[collectionName].push(data);
                saveToLocalStorage();
                return data;
            } else {
                try {
                    const docRef = await addDoc(collection(db, collectionName), data);
                    data.id = docRef.id;
                    return data;
                } catch(e) {
                    // Fallback if rules fail dynamically
                    useLocalStorage = true;
                    return apiAdd(collectionName, data);
                }
            }
        }

        async function apiUpdate(collectionName, id, data) {
            if (useLocalStorage) {
                const idx = appData[collectionName].findIndex(i => i.id === id);
                if (idx !== -1) {
                    appData[collectionName][idx] = { ...appData[collectionName][idx], ...data };
                    saveToLocalStorage();
                }
            } else {
                 try {
                    await updateDoc(doc(db, collectionName, id), data);
                 } catch(e) { useLocalStorage = true; apiUpdate(collectionName, id, data); }
            }
        }

        async function apiDelete(collectionName, id) {
             if (useLocalStorage) {
                appData[collectionName] = appData[collectionName].filter(i => i.id !== id);
                saveToLocalStorage();
            } else {
                try { await deleteDoc(doc(db, collectionName, id)); }
                catch(e) { useLocalStorage = true; apiDelete(collectionName, id); }
            }
        }

        async function fetchData() {
            // If using LocalStorage, data is already loaded in appData. 
            // If Firebase, fetch all collections.
            if (!useLocalStorage) {
                try {
                    const sSnap = await getDocs(collection(db, 'students'));
                    appData.students = sSnap.docs.map(d => ({id: d.id, ...d.data()}));

                    const subSnap = await getDocs(collection(db, 'subjects'));
                    appData.subjects = subSnap.docs.map(d => ({id: d.id, ...d.data()}));

                    const scSnap = await getDocs(collection(db, 'scores'));
                    appData.scores = scSnap.docs.map(d => ({id: d.id, ...d.data()}));
                    
                    const rSnap = await getDocs(collection(db, 'receipts'));
                    appData.receipts = rSnap.docs.map(d => ({id: d.id, ...d.data()}));
                } catch (e) {
                    console.log("Switching to local storage due to fetch error");
                    useLocalStorage = true;
                    loadFromLocalStorage();
                }
            }
            updateDashboard();
        }

        // --- AUTHENTICATION ---
        window.handleLogin = (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            
            if (u === 'Edu' && p === 'Edu123') {
                sessionStorage.setItem('nb_auth', 'true');
                checkAuth();
                fetchData();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        };

        window.logout = () => {
            sessionStorage.removeItem('nb_auth');
            location.reload();
        };

        function checkAuth() {
            const isAuth = sessionStorage.getItem('nb_auth');
            const loginScreen = document.getElementById('login-screen');
            const appContainer = document.getElementById('app-container');
            
            if (isAuth) {
                loginScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');
                updateDashboard(); // Initial Update
            } else {
                loginScreen.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        }

        // --- UI & NAVIGATION ---
        function setupUI() {
            // Populate Class Selects
            const selectors = ['student-class-select', 'filter-class', 'subject-class', 'filter-subject-class', 'score-class', 'report-class', 'receipt-class', 'timetable-class'];
            selectors.forEach(id => {
                const el = document.getElementById(id);
                if(!el) return;
                // Keep "All" for filters
                if (id.includes('filter') && !id.includes('subject')) return;
                
                el.innerHTML = id.includes('filter') ? '<option value="all">All Classes</option>' : '';
                CLASSES.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c;
                    opt.innerText = c;
                    el.appendChild(opt);
                });
            });

            // Set Sidebar Active
            window.navigate = (viewId) => {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                document.getElementById('view-' + viewId).classList.remove('hidden');
                
                // Mobile close sidebar
                if(window.innerWidth < 768) {
                    document.getElementById('sidebar').classList.add('hidden');
                }

                if(viewId === 'students') renderStudents();
                if(viewId === 'subjects') renderSubjects();
                if(viewId === 'scores') loadScoreEntry();
                if(viewId === 'finance') renderReceiptHistory();
            };

            window.toggleSidebar = () => {
                document.getElementById('sidebar').classList.toggle('hidden');
            };

            window.openModal = (id) => {
                document.getElementById(id).classList.remove('hidden');
            };

            window.closeModal = (id) => {
                document.getElementById(id).classList.add('hidden');
            };

            // Image Preview
            window.previewImage = (input) => {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('preview-photo').src = e.target.result;
                        document.getElementById('preview-photo').classList.remove('hidden');
                        document.getElementById('default-icon').classList.add('hidden');
                    }
                    reader.readAsDataURL(input.files[0]);
                }
            };
        }

        // --- DASHBOARD ---
        function updateDashboard() {
            document.getElementById('dash-total-students').innerText = appData.students ? appData.students.length : 0;
            document.getElementById('dash-total-receipts').innerText = appData.receipts ? appData.receipts.length : 0;
        }

        // --- STUDENTS ---
        window.handleStudentSave = async (e) => {
            e.preventDefault();
            const id = document.getElementById('student-id').value;
            const name = document.getElementById('student-name').value;
            const sClass = document.getElementById('student-class-select').value;
            const fileInput = document.getElementById('student-photo');
            
            let photoBase64 = document.getElementById('preview-photo').src;
            if(fileInput.files.length > 0) {
                // Already read in previewImage, src is set
            } else if (!photoBase64.includes('data:')) {
                photoBase64 = ""; // No image
            }

            const studentData = { name, class: sClass, photo: photoBase64 };

            if (id) {
                await apiUpdate('students', id, studentData);
            } else {
                await apiAdd('students', studentData);
            }

            closeModal('student-modal');
            document.getElementById('student-form').reset();
            document.getElementById('preview-photo').src = "";
            document.getElementById('preview-photo').classList.add('hidden');
            document.getElementById('default-icon').classList.remove('hidden');
            document.getElementById('student-id').value = "";
            
            await fetchData(); // Refresh local data
            renderStudents();
        };

        window.renderStudents = () => {
            const tbody = document.getElementById('student-table-body');
            tbody.innerHTML = '';
            
            const filterClass = document.getElementById('filter-class').value;
            const search = document.getElementById('search-student').value.toLowerCase();
            
            const filtered = appData.students.filter(s => {
                const matchClass = filterClass === 'all' || s.class === filterClass;
                const matchName = s.name.toLowerCase().includes(search);
                return matchClass && matchName;
            });

            filtered.forEach(s => {
                const row = `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-4">
                            <div class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden">
                                ${s.photo ? `<img src="${s.photo}" class="w-full h-full object-cover">` : '<i class="fas fa-user text-gray-400 p-2"></i>'}
                            </div>
                        </td>
                        <td class="p-4 font-medium">${s.name}</td>
                        <td class="p-4 text-gray-500">${s.class}</td>
                        <td class="p-4 text-right">
                            <button onclick="editStudent('${s.id}')" class="text-blue-600 hover:text-blue-800 mr-3"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteStudent('${s.id}')" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        };

        window.deleteStudent = async (id) => {
            if(confirm('Are you sure?')) {
                await apiDelete('students', id);
                fetchData().then(renderStudents);
            }
        };

        window.editStudent = (id) => {
            const s = appData.students.find(x => x.id === id);
            if(!s) return;
            document.getElementById('student-id').value = s.id;
            document.getElementById('student-name').value = s.name;
            document.getElementById('student-class-select').value = s.class;
            if(s.photo) {
                document.getElementById('preview-photo').src = s.photo;
                document.getElementById('preview-photo').classList.remove('hidden');
                document.getElementById('default-icon').classList.add('hidden');
            }
            openModal('student-modal');
        };

        // --- SUBJECTS ---
        window.handleAddSubject = async (e) => {
            e.preventDefault();
            const sClass = document.getElementById('subject-class').value;
            const name = document.getElementById('subject-name').value;
            
            await apiAdd('subjects', { class: sClass, name: name });
            document.getElementById('subject-name').value = '';
            fetchData().then(renderSubjects);
        };

        window.renderSubjects = () => {
            const list = document.getElementById('subject-list');
            list.innerHTML = '';
            const filter = document.getElementById('filter-subject-class').value || document.getElementById('subject-class').value;
            
            // Sync filter select if not set
            if(!document.getElementById('filter-subject-class').value) {
                document.getElementById('filter-subject-class').innerHTML = document.getElementById('subject-class').innerHTML;
            }

            const classSubjects = appData.subjects.filter(s => s.class === filter);
            
            classSubjects.forEach(s => {
                list.innerHTML += `<li class="p-2 border rounded bg-gray-50 flex justify-between">${s.name} <button onclick="deleteSubject('${s.id}')" class="text-red-500"><i class="fas fa-times"></i></button></li>`;
            });
        };

        window.deleteSubject = async (id) => {
            await apiDelete('subjects', id);
            fetchData().then(renderSubjects);
        };

        // --- SCORES ---
        window.loadScoreEntry = () => {
            const sClass = document.getElementById('score-class').value;
            const subSelect = document.getElementById('score-subject');
            const tbody = document.getElementById('score-table-body');
            tbody.innerHTML = '';

            // Update subjects dropdown for this class
            const subjects = appData.subjects.filter(s => s.class === sClass);
            subSelect.innerHTML = subjects.length ? '' : '<option>No subjects</option>';
            subjects.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.name; // Use name as ID for simplicity in linking
                opt.innerText = s.name;
                subSelect.appendChild(opt);
            });

            if(!subjects.length) return;

            const selectedSubject = subSelect.value;
            const students = appData.students.filter(s => s.class === sClass);

            students.forEach(std => {
                // Find existing score
                const existing = appData.scores.find(sc => sc.studentId === std.id && sc.subject === selectedSubject && sc.term === 'current'); // Simplified term logic
                
                const ca1 = existing ? existing.ca1 : '';
                const ca2 = existing ? existing.ca2 : '';
                const exam = existing ? existing.exam : '';

                const row = `
                    <tr data-sid="${std.id}">
                        <td class="p-3 border">${std.name}</td>
                        <td class="p-3 border"><input type="number" class="w-full border p-1 ca1" max="20" value="${ca1}" oninput="calcRow(this)"></td>
                        <td class="p-3 border"><input type="number" class="w-full border p-1 ca2" max="20" value="${ca2}" oninput="calcRow(this)"></td>
                        <td class="p-3 border"><input type="number" class="w-full border p-1 exam" max="60" value="${exam}" oninput="calcRow(this)"></td>
                        <td class="p-3 border font-bold text-center total">-</td>
                        <td class="p-3 border font-bold text-center grade">-</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            // Initial calc
            document.querySelectorAll('#score-table-body tr').forEach(tr => calcRow(tr.querySelector('input')));
        };

        window.calcRow = (input) => {
            const tr = input.closest('tr');
            const ca1 = parseFloat(tr.querySelector('.ca1').value) || 0;
            const ca2 = parseFloat(tr.querySelector('.ca2').value) || 0;
            const exam = parseFloat(tr.querySelector('.exam').value) || 0;
            
            // Limit checks
            if (ca1 > 20) tr.querySelector('.ca1').value = 20;
            if (ca2 > 20) tr.querySelector('.ca2').value = 20;
            if (exam > 60) tr.querySelector('.exam').value = 60;

            const total = (ca1 + ca2 + exam).toFixed(1);
            tr.querySelector('.total').innerText = total;

            // Grade
            const g = GRADING_SCALE.find(s => total >= s.min && total <= s.max);
            tr.querySelector('.grade').innerText = g ? g.grade : 'F';
        };

        window.saveAllScores = async () => {
            const sClass = document.getElementById('score-class').value;
            const subject = document.getElementById('score-subject').value;
            const rows = document.querySelectorAll('#score-table-body tr');
            
            let promises = [];
            
            rows.forEach(tr => {
                const sId = tr.getAttribute('data-sid');
                const ca1 = tr.querySelector('.ca1').value;
                const ca2 = tr.querySelector('.ca2').value;
                const exam = tr.querySelector('.exam').value;
                
                if (ca1 || ca2 || exam) {
                    // Check if update or add
                    const existing = appData.scores.find(sc => sc.studentId === sId && sc.subject === subject && sc.term === 'current');
                    
                    const data = {
                        studentId: sId,
                        class: sClass,
                        subject: subject,
                        ca1: ca1, ca2: ca2, exam: exam,
                        term: 'current'
                    };

                    if(existing) {
                        promises.push(apiUpdate('scores', existing.id, data));
                    } else {
                        promises.push(apiAdd('scores', data));
                    }
                }
            });

            await Promise.all(promises);
            alert('Scores Saved Successfully!');
            fetchData();
        };

        // --- REPORT CARDS (Complex Logic) ---
        window.generateReportCards = () => {
            const sClass = document.getElementById('report-class').value;
            const nextTerm = document.getElementById('next-term-date').value;
            const termName = document.getElementById('report-term').value;
            
            if(!nextTerm) { alert('Please enter Next Term begins date'); return; }

            const students = appData.students.filter(s => s.class === sClass);
            const reportList = document.getElementById('report-list');
            reportList.innerHTML = `<h3 class="w-full col-span-3 text-center mb-4 font-bold">Generated ${students.length} Reports. Click "Print" on a card or <button onclick="printAllReports()" class="text-blue-600 underline">Print All Bulk</button></h3>`;

            // Calculate Positions
            // 1. Get all students' totals average
            let studentAvgs = students.map(std => {
                // Get all scores for this student
                const scores = appData.scores.filter(sc => sc.studentId === std.id && sc.term === 'current');
                if(scores.length === 0) return { id: std.id, avg: 0 };
                
                let totalScore = 0;
                scores.forEach(s => {
                    totalScore += (parseFloat(s.ca1)||0) + (parseFloat(s.ca2)||0) + (parseFloat(s.exam)||0);
                });
                return { id: std.id, avg: totalScore / scores.length };
            });

            // 2. Sort descending
            studentAvgs.sort((a, b) => b.avg - a.avg);

            // Generate HTML for each student
            students.forEach(std => {
                // Find Rank
                const rankIndex = studentAvgs.findIndex(x => x.id === std.id);
                const position = rankIndex + 1;
                const suffix = (position) => {
                    const j = position % 10, k = position % 100;
                    if (j == 1 && k != 11) return position + "st";
                    if (j == 2 && k != 12) return position + "nd";
                    if (j == 3 && k != 13) return position + "rd";
                    return position + "th";
                };
                
                // Get Scores
                const scores = appData.scores.filter(sc => sc.studentId === std.id && sc.term === 'current');
                let totalMarks = 0;
                let rowsHTML = '';
                
                scores.forEach(sc => {
                    const total = (parseFloat(sc.ca1)||0) + (parseFloat(sc.ca2)||0) + (parseFloat(sc.exam)||0);
                    totalMarks += total;
                    const gradeObj = GRADING_SCALE.find(s => total >= s.min && total <= s.max) || { grade: 'F', remark: 'Fail' };
                    
                    rowsHTML += `
                        <tr class="text-xs border-b border-gray-300">
                            <td class="p-1 border-r border-gray-300">${sc.subject}</td>
                            <td class="p-1 text-center border-r border-gray-300">${sc.ca1||'-'}</td>
                            <td class="p-1 text-center border-r border-gray-300">${sc.ca2||'-'}</td>
                            <td class="p-1 text-center border-r border-gray-300">${sc.exam||'-'}</td>
                            <td class="p-1 text-center border-r border-gray-300 font-bold">${total}</td>
                            <td class="p-1 text-center border-r border-gray-300 text-${gradeObj.grade.startsWith('F')?'red':'green'}-700 font-bold">${gradeObj.grade}</td>
                            <td class="p-1 text-center text-xs italic">${gradeObj.remark}</td>
                        </tr>
                    `;
                });

                const average = scores.length ? (totalMarks / scores.length).toFixed(2) : 0;
                
                // Principal Comment Logic
                let pComment = "Good result, keep it up.";
                if(average >= 85) pComment = "An outstanding performance! Keep it up.";
                else if(average >= 70) pComment = "Very good result. A little more effort will yield excellence.";
                else if(average >= 50) pComment = "Good attempt, but needs to work harder next term.";
                else pComment = "Poor performance. Needs serious attention and improvement.";

                const cardHTML = `
                    <div class="report-card-page bg-white mx-auto relative text-gray-900 font-serif">
                        <!-- Border container -->
                        <div class="h-full border-4 border-double border-green-800 p-4 relative">
                            
                            <!-- Header -->
                            <div class="flex justify-between items-center border-b-2 border-green-700 pb-2 mb-2">
                                <div class="text-center w-full">
                                    <h1 class="text-2xl font-bold text-green-800 uppercase tracking-widest">Nurul Bayan Science Academy</h1>
                                    <h2 class="text-xl font-bold arabic-text text-yellow-600">Ù†ÙˆØ± Ø§Ù„Ø¨ÙŠØ§Ù† Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ù„Ù„Ø¹Ù„ÙˆÙ…</h2>
                                    <p class="text-xs mt-1">No. 2222 Janbulo Housing Estate, Opposite Afforestation, Dorayi Babba, Gwale LGA, Kano</p>
                                    <p class="text-xs font-bold">Tel: +234-8119723517, +234-8189231849 | Email: nurulbayanscienceacademy18@gmail.com</p>
                                    <div class="bg-green-700 text-white text-xs py-1 px-4 rounded-full inline-block mt-1 font-bold">Motto: Knowledge is the Root of Success</div>
                                </div>
                            </div>

                            <!-- Student Info -->
                            <div class="flex gap-4 mb-3 items-end">
                                <div class="w-24 h-28 border border-gray-400 bg-gray-100 flex-shrink-0">
                                    ${std.photo ? `<img src="${std.photo}" class="w-full h-full object-cover">` : '<div class="flex items-center justify-center h-full text-xs text-gray-400">No Photo</div>'}
                                </div>
                                <div class="flex-1 grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                                    <div class="flex"><span class="font-bold w-24">Name:</span> <span class="border-b border-dotted border-gray-400 flex-1">${std.name}</span></div>
                                    <div class="flex"><span class="font-bold w-24">Class:</span> <span class="border-b border-dotted border-gray-400 flex-1">${std.class}</span></div>
                                    <div class="flex"><span class="font-bold w-24">Term:</span> <span class="border-b border-dotted border-gray-400 flex-1">${termName}</span></div>
                                    <div class="flex"><span class="font-bold w-24">Session:</span> <span class="border-b border-dotted border-gray-400 flex-1">2025 / 2026</span></div>
                                    <div class="flex"><span class="font-bold w-24">Position:</span> <span class="border-b border-dotted border-gray-400 flex-1 font-bold text-lg">${suffix(position)}</span></div>
                                    <div class="flex"><span class="font-bold w-24">No. in Class:</span> <span class="border-b border-dotted border-gray-400 flex-1">${students.length}</span></div>
                                </div>
                            </div>

                            <!-- Scores Table -->
                            <table class="w-full border-collapse border border-gray-800 mb-4">
                                <thead class="bg-green-100 text-xs">
                                    <tr>
                                        <th class="border border-gray-600 p-1 text-left w-1/3">Subject</th>
                                        <th class="border border-gray-600 p-1 w-10">CA1</th>
                                        <th class="border border-gray-600 p-1 w-10">CA2</th>
                                        <th class="border border-gray-600 p-1 w-10">Exam</th>
                                        <th class="border border-gray-600 p-1 w-10">Total</th>
                                        <th class="border border-gray-600 p-1 w-10">Grd</th>
                                        <th class="border border-gray-600 p-1">Remarks</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rowsHTML}
                                </tbody>
                                <tfoot class="bg-gray-50 text-xs font-bold">
                                    <tr>
                                        <td colspan="4" class="p-1 text-right pr-4">Average:</td>
                                        <td colspan="3" class="p-1 pl-2">${average}</td>
                                    </tr>
                                </tfoot>
                            </table>

                            <!-- Footer Info -->
                            <div class="mt-auto absolute bottom-4 left-4 right-4">
                                <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                                    <div>
                                        <p class="font-bold mb-1">Principal's Comment:</p>
                                        <p class="text-xs italic border-b border-gray-400 pb-1">${pComment}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-bold mb-1">Next Term Begins:</p>
                                        <p class="text-xs border-b border-gray-400 pb-1">${new Date(nextTerm).toDateString()}</p>
                                    </div>
                                </div>

                                <div class="flex justify-between items-center mt-4">
                                    <div class="text-center">
                                        <div class="school-stamp mb-1 mx-auto text-[8px] leading-tight flex flex-col justify-center">
                                            <span>NURUL BAYAN</span>
                                            <span>SCIENCE ACADEMY</span>
                                            <span class="text-red-600 text-xs mt-1">OFFICIAL</span>
                                        </div>
                                        <p class="text-[10px] font-bold">Principal's Signature</p>
                                    </div>
                                    
                                    <div class="text-center">
                                        <div id="qr-${std.id}" class="mb-1"></div>
                                        <p class="text-[9px] text-gray-500">Scan to Verify</p>
                                    </div>
                                </div>

                                <div class="mt-4 border-t border-gray-300 pt-1 text-center">
                                    <p class="text-[10px] font-bold text-red-600">NOTICE TO PARENTS: Please ensure school fees are paid promptly before resumption.</p>
                                    <p class="text-[8px] text-gray-400 mt-1">Developed by Abu-Abdurrahman CodeVerge Technology | +2348107907647</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Add to list as a card
                const wrapper = document.createElement('div');
                wrapper.className = "bg-gray-100 p-2 rounded border shadow-sm flex flex-col gap-2";
                wrapper.innerHTML = `
                    <div class="font-bold text-sm">${std.name}</div>
                    <div class="text-xs text-gray-500">Pos: ${suffix(position)} | Avg: ${average}</div>
                    <button class="bg-gray-800 text-white text-xs py-1 rounded hover:bg-black" onclick="printReport('${std.id}')">Print</button>
                    <!-- Hidden Container for actual HTML storage -->
                    <div id="html-${std.id}" class="hidden">${cardHTML}</div>
                `;
                reportList.appendChild(wrapper);

                // Generate QR Code (Delayed to ensure DOM exists if we were appending directly, but here we generate on demand or in background)
                // Since qrcode.js needs a DOM element, we do it in print function
            });
        };

        window.printReport = (id) => {
            const content = document.getElementById(`html-${id}`).innerHTML;
            const printArea = document.getElementById('print-area');
            printArea.innerHTML = content;
            
            // Generate QR
            const qrDiv = printArea.querySelector(`#qr-${id}`);
            if(qrDiv) {
                qrDiv.innerHTML = "";
                new QRCode(qrDiv, {
                    text: `NURUL BAYAN\nStudent: ${id}\nTerm: 1st\nValid: YES`,
                    width: 60,
                    height: 60,
                    colorDark : "#047857",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });
            }

            window.print();
        };

        window.printAllReports = async () => {
            const cards = document.querySelectorAll('[id^="html-"]');
            const printArea = document.getElementById('print-area');
            printArea.innerHTML = ''; // Clear

            // Loop and append all with page breaks
            cards.forEach(card => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = card.innerHTML;
                
                // Fix QR logic for bulk
                const id = card.id.replace('html-', '');
                const qrDiv = tempDiv.querySelector(`#qr-${id}`);
                
                // Need to append to DOM to generate QR
                printArea.appendChild(tempDiv);
                
                if(qrDiv) {
                    new QRCode(qrDiv, {
                        text: `NURUL BAYAN\nID: ${id}`,
                        width: 60,
                        height: 60
                    });
                }
            });
            
            setTimeout(() => window.print(), 1000); // Allow QR generation
        };

        window.exportExcel = () => {
            const sClass = document.getElementById('report-class').value;
            const students = appData.students.filter(s => s.class === sClass);
            
            const data = [];
            students.forEach(std => {
                 const scores = appData.scores.filter(sc => sc.studentId === std.id && sc.term === 'current');
                 let row = { "Name": std.name, "Class": std.class };
                 scores.forEach(s => {
                     row[`${s.subject} Total`] = (parseFloat(s.ca1)||0) + (parseFloat(s.ca2)||0) + (parseFloat(s.exam)||0);
                 });
                 data.push(row);
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, sClass);
            XLSX.writeFile(wb, `${sClass}_Scores.xlsx`);
        };

        // --- RECEIPTS ---
        window.generateReceipt = async (e) => {
            e.preventDefault();
            const receipt = {
                name: document.getElementById('receipt-name').value,
                class: document.getElementById('receipt-class').value,
                amount: document.getElementById('receipt-amount').value,
                date: document.getElementById('receipt-date').value,
                purpose: document.getElementById('receipt-purpose').value,
                timestamp: Date.now()
            };

            const saved = await apiAdd('receipts', receipt);
            printReceipt(saved);
            document.getElementById('receipt-name').value = '';
            document.getElementById('receipt-amount').value = '';
            fetchData(); // Update history
        };

        window.printReceipt = (r) => {
             const printArea = document.getElementById('print-area');
             const receiptHTML = `
                <div class="receipt-page bg-white p-8 border-2 border-gray-800 font-serif relative overflow-hidden">
                     <!-- Watermark -->
                    <div class="absolute inset-0 flex items-center justify-center opacity-5 pointer-events-none">
                        <div class="text-9xl font-bold transform -rotate-45">PAID</div>
                    </div>

                    <div class="text-center border-b-2 border-gray-800 pb-4 mb-6">
                        <h1 class="text-3xl font-bold text-green-800 uppercase">NURUL BAYAN SCIENCE ACADEMY</h1>
                        <p class="text-sm">No. 2222 Janbulo Housing Estate, Kano</p>
                        <p class="text-sm font-bold mt-2">OFFICIAL PAYMENT RECEIPT</p>
                    </div>

                    <div class="flex justify-between mb-6">
                        <div>
                            <p><strong>Receipt No:</strong> <span class="text-red-600 font-mono">NB-${r.id.substring(0,6).toUpperCase()}</span></p>
                            <p><strong>Date:</strong> ${r.date}</p>
                        </div>
                        <div class="text-right">
                             <p><strong>Session:</strong> 2025/2026</p>
                        </div>
                    </div>

                    <div class="mb-8 space-y-4 text-lg">
                        <div class="flex border-b border-dotted border-gray-400 pb-1">
                            <span class="w-32 font-bold">Received From:</span>
                            <span class="flex-1 italic">${r.name} (${r.class})</span>
                        </div>
                        <div class="flex border-b border-dotted border-gray-400 pb-1">
                            <span class="w-32 font-bold">The Sum of:</span>
                            <span class="flex-1 font-bold">â‚¦${parseInt(r.amount).toLocaleString()}</span>
                        </div>
                        <div class="flex border-b border-dotted border-gray-400 pb-1">
                            <span class="w-32 font-bold">Payment For:</span>
                            <span class="flex-1">${r.purpose}</span>
                        </div>
                    </div>

                    <div class="flex justify-between items-end mt-12">
                        <div class="text-center w-32">
                             <div class="border-b border-gray-800 mb-1"></div>
                             <p class="text-xs">Accountant Sig</p>
                        </div>
                         <div class="school-stamp">
                             PAID<br>${r.date}
                        </div>
                        <div class="text-center w-32">
                             <div class="border-b border-gray-800 mb-1">Manager</div>
                             <p class="text-xs">Management Sig</p>
                        </div>
                    </div>
                    
                    <div class="text-center text-xs mt-8 text-gray-500">
                        Generated by Abu-Abdurrahman CodeVerge Technology
                    </div>
                </div>
             `;
             printArea.innerHTML = receiptHTML;
             window.print();
        };

        window.renderReceiptHistory = () => {
             const list = document.getElementById('receipt-history');
             list.innerHTML = '';
             // Sort by newest
             const sorted = [...appData.receipts].sort((a,b) => b.timestamp - a.timestamp);
             
             sorted.forEach(r => {
                 list.innerHTML += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-2 text-xs font-mono text-gray-500">..${r.id.substr(-4)}</td>
                        <td class="p-2 font-medium">${r.name}</td>
                        <td class="p-2">â‚¦${parseInt(r.amount).toLocaleString()}</td>
                        <td class="p-2 text-right">
                            <button onclick='reprintReceipt("${r.id}")' class="text-blue-600 text-sm hover:underline">Reprint</button>
                        </td>
                    </tr>
                 `;
             });
        };
        
        window.reprintReceipt = (id) => {
            const r = appData.receipts.find(x => x.id === id);
            if(r) printReceipt(r);
        };

        // --- TIMETABLE ---
        window.renderTimetableEditor = () => {
            const tbody = document.getElementById('timetable-body');
            tbody.innerHTML = '';
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            
            days.forEach(day => {
                let row = `<tr class="border-b"><td class="p-3 font-bold bg-green-50 border-r border-green-200">${day}</td>`;
                
                // 6 Periods + Break logic
                // 1, 2, 3
                for(let i=1; i<=3; i++) {
                    row += `<td class="p-1 border-r border-green-100" contenteditable="true"></td>`;
                }
                // Break
                row += `<td class="bg-gray-200 text-xs font-bold text-gray-500 align-middle rotate-0">BREAK</td>`;
                // 4, 5, 6
                 for(let i=4; i<=6; i++) {
                    row += `<td class="p-1 border-r border-green-100" contenteditable="true"></td>`;
                }
                row += `</tr>`;
                tbody.innerHTML += row;
            });
        };

        window.printTimetable = () => {
             const tClass = document.getElementById('timetable-class').value;
             const content = document.getElementById('timetable-editor').outerHTML;
             
             const printArea = document.getElementById('print-area');
             printArea.innerHTML = `
                <div class="timetable-page bg-white p-4">
                    <div class="text-center mb-4">
                        <h1 class="text-2xl font-bold text-green-800">NURUL BAYAN SCIENCE ACADEMY</h1>
                        <h2 class="text-xl">Class Timetable: <span class="font-bold underline">${tClass}</span></h2>
                        <p>Session: 2025/2026</p>
                    </div>
                    <div class="border-2 border-green-800 p-1">
                        ${content}
                    </div>
                    <div class="mt-4 text-center text-xs">Developed by Abu-Abdurrahman CodeVerge Technology</div>
                </div>
             `;
             
             // Inject styles into print area context (CSS takes care of .timetable-page)
             window.print();
        };

        // START
        initApp();

    </script>
</body>
</html>
